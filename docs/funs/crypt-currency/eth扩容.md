## ETH扩容

## 背景

网络的拥堵以及高GAS费问题一直是以太坊遭到诟病的两大重要因素，为了提升用户体验，如何对以太坊进行高效安全的扩容成为当下一个迫切的问题。

## 扩容方案

- ### 第一种是在Layer 1方向上的扩容

  L1的扩容叫做链上扩容，通过修改区块链的修改规则，包括区块大小、共识机制等来做到。

  比如，加密货币圈就曾经热议过，考虑把比特币的区块大小增加来提高比特币的转账速度。

  又比如，以太坊 2.0 的设计，是将共识机制由 PoW 转换成 PoS，并采用改变网络验证方式的分片技术来提高效率。

  这也是以太坊2.0正在做的事情，通过分片、PoS机制等方式提升以太坊区块链吞吐量，从而提高效率；

- ### 第二种是Layer 2方向上的扩容

  它在以太坊或者其他公链上搭建二层网络，提升交易速度。

  Layer2 解决方案的思路是：

  **把计算、交易等业务处理拿到主链( layer1 )之外来执行，只在主链上反映最终的结果**，中间过程不在主链做记录。

  无论多么复杂的应用对主链都不会有影响，所以目前有建树的项目都开始开发使用 Layer2 技术。
  
  > 通俗的讲：
  >
  > 这就好比Layer1是计算机硬件，layer2就是从软件层面发挥硬件的性能。

目前

鉴于当下各种DeFi项目以及其他DApp对以太坊网络的需求飙升，同时以太坊2.0上线存在的巨大不确定性，让Layer 2成为首选解决方案。

## 扩容技术路线对比

Layer2的扩容技术主要分为

- 状态通道

  > **优点：延迟低，实时性高**
  > **缺点：用户人数有限，资金利用率低**
  > **用途：小额支付 / 预测市场 / 赌球赛马**
  >
  > 状态通道的核心简单来讲：不再使用链上交易，希望定期进行交易的各方可以先在智能合约中锁定资金，然后在链外交换签名的消息，
  >
  > 这些消息用来更新谁拥有哪些资金的状态。
  >
  > 任何数量的交易都可以在链外发生，其速度只受限于各方**交换签名信息**的能力。
  >
  > 例子：
  >
  > 我们假设Alice和Bob这两个人他们都向基础链上的智能合约存入资金 － 比方每个人存5个ETH。
  >
  > 第一笔交易：Alice对支付给Bob 1个ETH的消息进行签名，这意味着她将自己的余额更新为4 ETH，Bob的余额更新为6 ETH。Alice将签过名的消息发送给Bob，Bob对更新后的状态进行签名并返回。
  >
  > 第二笔交易：之后，Bob向Alice支付0.5 ETH，将自己的余额减为5.5 ETH，将她的余额增为4.5 ETH。他对这次的支付信息进行签名，并发送给Alice，然后她也对这个信息签名并将其发送回去。
  >
  > 只要Alice和Bob愿意，这个过程就会重复。值得注意的是，小额支付在这个系统中是可以的。由于在通道结算之前没有任何费用，所以发送1000笔0.001ETH的付款和发送一笔1ETH的付款从成本上是一样的。
  >
  > 最终，Alice和Bob的交易告一段落。双方最后签了名的余额是，Alice有7个ETH，Bob有3个ETH。她将这最后一个共同签名的状态提交给基础链，基础链首先验证双方确实是用私钥签名的，然后根据所表明的余额发放给双方。

- 侧链（Sidechain）

  > **优点：代码和数据独立，不增加主链的负担**
  > **缺点：安全性弱**
  >
  > 侧链的本质就是在这个基础层上再搭一个链，然后用完全另外一套验证人。
  >
  > 它的整个安全性是分开的：主链有主链的安全性，侧链有侧链的安全性。
  >
  > 主链从 POW 转到 POS 会有更强的安全性，但侧链的验证人偏少，安全性也较弱：比如说 Cosmos 	才只有 100 个验证人。
  >
  > **工作原理**
  > 例如以比特币区块链作为主链（Parent chain），其他区块链作为侧链，二者通过**双向挂钩（Two-way peg）**，可实现比特币从主链转移到侧链进行流通。
  >
  > **双向挂钩（Two-way peg）是侧链实现的核心原理**。
  >
  > 当主链与侧链进行比特币转移时， “转移”实际上是一种错觉，
  >
  > 真实情况是：比特币其实并没有转移，但在比特币区块链上被**暂时锁定**，而同时在侧链上有相同数量的等价token被解锁。
  >
  > 当等量的token在侧链上被再次锁定时，原先的比特币就会**被解锁**。这实质上就是双向挂钩所要实现的功能。

- Plasma

  > 缺点：取出资金时间过长；
  >
  > 不同于侧链，Plasma 将 Layer2 交易数据处理后提交到 Layer1，并且增加了欺诈性证明的退出机制，通过这种方式利用 Layer1 算力保障 Layer2 安全性。
  >
  > 这个协议只提高吞吐量，而不是降低交易延迟。

- Optimistic Rollup

  > **优点：可以支持通用的智能合约，缺点是需一到两周时间去跑证明**
  >
  > **缺点：是需一到两周时间去跑证明**
  >
  > Optimistic Rollup 从技术来说要比 ZK Rollup 简单很多，它的好处是可以支持通用的智能合约。
  >
  > ZK 和 Optimistic 的区别是，Fraud Proof 变成了 Validity Proof。
  >
  > 这两种验证方式相当于两种不同的思维方式：
  >
  > Optimistic Rollup 是乐观思维，就是说相信验证人是不会做恶的；Optimistic 和 ZK 都牵涉到一个最终性的问题。
  >
  > Optimistic Rollup 的最终性是比较长的，用户没有跑过这个证明，提现期需要一到两周。这期间系统会给足够多的窗口，让足够多的人去验证这个乐观的事情。

- ZK Rollup

  > ZK 是悲观思维，相信验证人还是会作恶的，所以要生成一个零知识证明，然后和 Rollup 一起打包到链上去。大家去验证不需要跑状态转移，因为这个转移已经通过零知识证明跑过一遍了。所以ZK Rollup 相当于自证清白。
  >
  > 那么 ZK Rollup 的问题是什么呢？它对于这个节点要求是非常非常高的。ZK Rollup 就是耗 CPU 和内存，并需要很强的服务器去做这个打包。而 Optimistic Rollup 对于打包者的要求并不那么高。唯一要求的就是验证人在链上质押来保证不会作恶。

- Vadium

在这其中，**Rollup**又是当下最热门并且被V神力捧的扩容技术。

## Rollup扩容路线备受追捧

> Rollup 就是链下的计算+链上的数据+Fraud proof。
>
> 然后它最关键的一个点就是不是所有数据都在链上，它的链上数据仅仅限于它每一笔交易的输入，但不包括它的最终状态。
>
> 比如说，你从 a 走到 b ，我只是把路径告诉你了；但是你具体在 a 做了什么事，在 b 做了什么事，这种状态是记录在链下的。

Rollup主要分为两种技术路线，目前这两种Rollup技术也是安全性最高的Layer 2路径：

- ### ZK Rollup

  技术使用零知识证明；

  ZK rollup的优势更凸显在它的**安全性**上。它通过引入零知识证明技术，从而可以在链下批量执行所有计算，而只需向以太坊提交一个零知识证明进行验证（以太坊会验证这些证明），并且存储足够的数据来准确判断链下账户的状态，它拥有以太坊层级的安全性。

  相比Optimistic rollup，可扩展性更强，ZK Rollup方案称得上是目前的最佳方案。

  Tether也在考虑将ERC-20的USDT迁移至ZK Rollup的Layer2上。

  > [什么是零知识证明](https://www.jianshu.com/p/3f524c925c34) 
  >
  > A 拥有 B 的公钥，A 没有见过 B，而 B 见过 A 的照片，
  >
  > 某天二人偶然碰面，B 认出了 A，但 A 不能确定面前的人是否是 B，
  >
  > 这时 B 要向 A 证明自己是 B，也有两个方法：
  >
  > 1. B 把自己的私钥给 A，A 用这个私钥对某个数据加密，然后用 B 的公钥解密，如果正确，则证明对方确实是 B。
  >
  > 2. A给出一个随机值，B 用自己的私钥对其加密，然后把加密后的数据交给 A，A 用 B 的公钥解密，如果能够得到原来的随机值，则证明对方是 B。
  >
  > 后面的方法就属于零知识证明。

- ### Optimistic Rollup

  最大的好处，不用重写智能合约的代码！

  技术使用欺诈证明；

  Optimistic Rollups的优势在于它的**通用计算**，相比于ZK Rollup的特定应用场景（支付、交易），在Optimistic Rollups上几乎任何在以太坊能实现的都可以同等实现，包括DeFi的智能合约的可组合性。
  
  Optimistic Rollup与侧链不同，所有重建乐观虚拟机（OVM）状态的数据始终存在以太坊主网上。
  
  存在一个称为规范事务链（CTC）的不可更改的事务日志，它包含了特定顺序中的所有单个事务。
  
  任何人都可以查看此事务日志并重建 OVM 状态。
  
  这意味着，尽管我们必须等待 1 周以确保 CTC 的计算结果是正确的，但我们可以在几分钟内获得单独事务是正确的链外证明。
  
  > 以太坊已经围绕其开发者生态系统发展了护城河。开发人员的技术栈包括：
  >
  > - Solidity/ Vyper：这是两种最流行的智能合约编程语言，有很多工具链围绕它们构建，例如 [Ethers](https://github.com/ethers-io/ethers.js/)、[Hardhat](https://github.com/nomiclabs/hardhat)、 [dapp](http://dapp.tools/)、[slither](https://github.com/crytic/slither)等。
  > - 以太坊虚拟机：最流行的区块链虚拟机，其内部设计比任何其他区块链VM都要好得多。
  > - Go-ethereum：主流以太坊协议实现，采用率 > 75％，经过了广泛的测试。
  >
  > 由于Optimism Rollup将以太坊作为其第1层，因此如果我们可以**无需修改即可重用现有工具**，那就太好了。 
  >
  > 这将改善开发人员的体验，因为开发人员无需学习新技术。虽然已经多次提出，但是我想强调软件重用 的另一个含义：安全性。
  >
  > [Optimistic技术详解](http://blog.hubwiz.com/2021/02/12/optimism-rollup/)
  
  

## Rollup技术价值

V神的观点也佐证了ZK Rollup未来的巨大发展潜力。他在推特上表示，在短期内，Optimistic rollup有机会赢得多用途的EVM计算，ZKrollup则有望在简单支付层面、交易平台以及其他特定于应用程序的用例上更胜一筹。不过在中长期来看，ZK Rollup会随着ZK-SNARK技术的改进，在所有用例中胜出。

**虽然Rollup方案看起来似乎是在以太坊2.0到来前的应急之策，但从以太坊网络的长期价值属性看，即便未来以太坊2.0正式上线后，Rollup技术可能也不会被抛弃，它们将在原有的基础上继续增强吞吐量和网络的可用性。**



## Rollup相关项目

- ### zkSync

  > Matter Labs 创始人 Alex Gluchowski 表示，zkSync 会发布治理代币，代币可能会叫做 MLTT
  >
  > zkSync 是欧洲团队 Matter Labs 推出的一款以太坊 Layer2 扩容方案，其基于 ZK Rollup 架构打造，不仅能实现每秒数千笔（TPS）交易的 VISA 级吞吐量；
  >
  > 每个 Rollup 块所生成的状态转移零知识证明（SNARK），还能够充分地保证链上资金以及 Layer1 账户的安全性与隐私性；
  >
  > 相比同类扩容方案，其提币速度仅需 10 分钟左右。这些特点让 zkSync 备受社区关注，并逐渐成为被寄予厚望的以太坊扩容方案之一。
  >
  > ————————
  >
  > 北京时间3月30日凌晨向用户发邮件，更新zkSync 2.0的路线图以及时间线。
  >
  > 根据zkSync2.0路线图，预计将于5月份上线zkSync2.0公开测试网，8月份上线主网。
  >
  > 此外，zkSync 1.x将很快支持NFT的原生铸造，传输和原子交换，并具有zkRollup的完全安全保证。

  目前**原生支持所有以太坊钱包**

- ### Optimism 

  > Optimism是一个OR实现，在一些DeFi大玩家中获得了早期的吸引力，比如Synthetix、Uniswap等。
  >
  > Optimism已经构建了OVM，这是一个基于L2的EVM，它使得项目可以在L2上享受以太坊的L1智能合约的所有好处。
  >
  > 为了确保整个社区能协调上线，让基础项目、基础设施提供方、出块方、钱包、代币桥等有时间进行集成，Optimism将延迟公共主网上线时间，预计在今年2021-7月份上线。
  
  Synthetix、Chainlink和Uniswap都是早期项目；
  
  uniswap v3已经决定使用`Optimism`扩容路线，不过目前【20210402】因为主网还没上线，所以v3的正式L2迁移还需时日；
  
  - Uniswap v3版本已确定使用
  
  - Synthetix  **已上线，采用 Optimism 方案**
  
    [可试用synthetiv L2指南](https://www.chainnews.com/articles/374698087458.htm)
  
  

## L2发币方向

- Matter Labs 创始人 Alex Gluchowski 表示，zkSync 会发布治理代币
- Offchain labs (Arbitrum 方案的创建团队) 会跟进发币
- Starkware 也会跟进发币
- Optimism 刚宣布获得 a16z 加密风投基金领投的 2500 万美元 A 轮投资，将在 3 月份公开上线主网，尽管没有明确信息，但在我看来 Optimism 发币只是时间问题。