## æµåª’ä½“

æµåª’ä½“æ˜¯æŒ‡é‡‡ç”¨æµå¼ä¼ è¾“æ–¹å¼åœ¨ Internet ä¸Šæ’­æ”¾çš„åª’ä½“æ ¼å¼ï¼Œä¾‹å¦‚éŸ³é¢‘ã€è§†é¢‘ç­‰å¤šåª’ä½“æ–‡ä»¶ã€‚

## æµå¼ä¼ è¾“æ–¹å¼

æµå¼ä¼ è¾“æ–¹å¼æ˜¯å°†å¤šåª’ä½“æ–‡ä»¶ç»è¿‡ç‰¹æ®Šå‹ç¼©ååˆ†æˆä¸€ä¸ªä¸ªå‹ç¼©åŒ…ï¼Œå†ç”±æœåŠ¡å™¨å‘å®¢æˆ·ç«¯è¿ç»­ã€å®æ—¶ä¼ é€ã€‚

ç”¨æˆ·ä¸å¿…åƒéæµå¼ä¼ è¾“é‚£æ ·ç­‰å¾…æ•´ä¸ªæ–‡ä»¶å…¨éƒ¨ä¸‹è½½å®Œæ¯•åæ‰èƒ½æ’­æ”¾ï¼Œè€Œæ˜¯åªéœ€è¦ç»è¿‡å‡ ç§’é’Ÿæˆ–å‡ åç§’çš„å¯åŠ¨å»¶æ—¶å³å¯å¯¹å‹ç¼©çš„éŸ³è§†é¢‘æ–‡ä»¶è¿›è¡Œæ’­æ”¾ï¼Œå‰©ä½™çš„éƒ¨åˆ†å°†ç»§ç»­ä¸‹è½½ï¼Œç›´è‡³æ’­æ”¾å®Œæ¯•ã€‚

## æµåª’ä½“ä¼ è¾“åè®®

å¸¸ç”¨çš„æµåª’ä½“ä¼ è¾“åè®®ä¸»è¦æœ‰`HTTPæ¸è¿›å¼ä¸‹è½½`å’Œ`å®æ—¶æµåª’ä½“åè®®`ä¸¤ç±»ã€‚

### HTTPæ¸è¿›å¼ä¸‹è½½

ä»…èƒ½ä¼ è¾“å®Œæ•´çš„éŸ³è§†é¢‘æ–‡ä»¶ï¼Œåœ¨ç»™å®šæ—¶åˆ»ï¼Œç”¨æˆ·åªèƒ½è§‚çœ‹å·²ä¸‹è½½çš„é‚£éƒ¨åˆ†ï¼Œè€Œä¸èƒ½è·³åˆ°è¿˜æœªä¸‹è½½çš„éƒ¨åˆ†ã€‚

HTTPè¾¹ä¸‹è½½è¾¹æ’­æ”¾ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šè®²ï¼Œä¸æ˜¯ç›´æ’­åè®®ã€‚

ä»–çš„åŸç†æ˜¯å…ˆä¸‹è½½æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ï¼ŒéŸ³é¢‘è§†é¢‘çš„æ—¶é—´æˆ³ï¼Œå†ä¸‹è½½éŸ³è§†é¢‘æ•°æ®ï¼Œä»¥æ’­æ”¾mp4ä¸ºä¾‹ï¼Œå…ˆä¸‹è½½æ–‡ä»¶å¤´ï¼Œæ ¹æ®æ–‡ä»¶å¤´æŒ‡å¼•ä¸‹è½½æ–‡ä»¶å°¾ï¼Œç„¶åå†ä¸‹è½½æ–‡ä»¶çš„éŸ³è§†é¢‘æ•°æ®ã€‚

### å®æ—¶æµåª’ä½“åè®®

å¯ç”¨äºå®å†µç›´æ’­ï¼Œä¹Ÿå¯ä¼ è¾“å®Œæ•´çš„éŸ³è§†é¢‘æ–‡ä»¶ã€‚

ä¾‹å¦‚RTSP/RTPã€RTMPã€HLSã€HTTP-FLVã€‚

## ç›´æ’­æµåè®®

### RTMPï¼ˆReal Time Messaging Protocolï¼‰

åè®®æ¯”è¾ƒå…¨èƒ½ï¼Œæ—¢å¯ä»¥ç”¨æ¥æ¨é€ï¼Œåˆå¯ä»¥ç”¨æ¥ç›´æ’­ã€‚

å…¶æ ¸å¿ƒç†å¿µæ˜¯å°†å¤§å—çš„è§†é¢‘å¸§å’ŒéŸ³é¢‘å¸§â€œå‰ç¢â€ï¼Œç„¶åä»¥å°æ•°æ®åŒ…çš„å½¢å¼åœ¨äº’è”ç½‘ä¸Šè¿›è¡Œä¼ è¾“ï¼Œä¸”æ”¯æŒåŠ å¯†ï¼Œå› æ­¤éšç§æ€§ç›¸å¯¹æ¯”è¾ƒç†æƒ³ï¼Œä½†æ‹†åŒ…ç»„åŒ…çš„è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œæ‰€ä»¥åœ¨æµ·é‡å¹¶å‘æ—¶å®¹æ˜“å‡ºç°ä¸€äº›ä¸å¯é¢„æœŸçš„ç¨³å®šæ€§é—®é¢˜ã€‚

### HLSï¼ˆHTTP Live Streamingï¼‰

è‹¹æœæ¨å‡ºçš„è§£å†³æ–¹æ¡ˆï¼Œå°†è§†é¢‘åˆ†æˆ 5-10 ç§’çš„è§†é¢‘å°åˆ†ç‰‡ï¼Œç„¶åç”¨ M3U8 ç´¢å¼•è¡¨è¿›è¡Œç®¡ç†ã€‚

ç”±äºå®¢æˆ·ç«¯ä¸‹è½½åˆ°çš„è§†é¢‘éƒ½æ˜¯ 5-10 ç§’çš„å®Œæ•´æ•°æ®ï¼Œæ•…è§†é¢‘çš„æµç•…æ€§å¾ˆå¥½ï¼Œä½†ä¹ŸåŒæ ·å¼•å…¥äº†å¾ˆå¤§çš„å»¶è¿Ÿï¼ˆHLS çš„ä¸€èˆ¬å»¶è¿Ÿåœ¨ 10-30s å·¦å³ï¼‰ã€‚

ç›¸æ¯”äº FLVï¼ŒHLS åœ¨iPhone å’Œå¤§éƒ¨åˆ† Android æ‰‹æœºæµè§ˆå™¨ä¸Šçš„æ”¯æŒéå¸¸ç»™åŠ›ï¼Œæ‰€ä»¥å¸¸ç”¨äº QQ å’Œå¾®ä¿¡æœ‹å‹åœˆçš„ URL åˆ†äº«ã€‚

### HTTP-FLVï¼ˆFlash Videoï¼‰

ç”± Adobe å…¬å¸ä¸»æ¨ï¼Œæ ¼å¼æå…¶ç®€å•ï¼Œåªæ˜¯åœ¨å¤§å—çš„è§†é¢‘å¸§å’ŒéŸ³è§†é¢‘å¤´éƒ¨åŠ å…¥ä¸€äº›æ ‡è®°å¤´ä¿¡æ¯ï¼Œç”±äºè¿™ç§æè‡´çš„ç®€æ´ï¼Œåœ¨å»¶è¿Ÿè¡¨ç°å’Œå¤§è§„æ¨¡å¹¶å‘æ–¹é¢éƒ½å¾ˆæˆç†Ÿã€‚

å”¯ä¸€çš„ä¸è¶³å°±æ˜¯åœ¨æ‰‹æœºæµè§ˆå™¨ä¸Šçš„æ”¯æŒéå¸¸æœ‰é™ï¼Œä½†æ˜¯ç”¨ä½œæ‰‹æœºç«¯ APP ç›´æ’­åè®®å´å¼‚å¸¸åˆé€‚ã€‚





åœ¨æ”¯æŒæµè§ˆå™¨çš„åè®®é‡Œï¼Œå»¶è¿Ÿæ’åº(ç”±é«˜åˆ°ä½)æ˜¯ï¼š

**HLS > WebSocket-FLV >RTMP = HTTP-FLV**

è€Œæ€§èƒ½æ’åº(ç”±é«˜åˆ°ä½)æ°å¥½ç›¸åï¼š

**RTMP > HTTP-FLV = WebSocket-FLV > HLS**



navigatorå¯¹è±¡ä¸­åŒ…å« è§†é¢‘å¯¹è±¡[MediaDevices.getUserMedia()](https://developer.mozilla.org/zh-CN/docs/Web/API/MediaDevices/getUserMedia)ï¼Œ å¯ä»¥ç›´æ¥é€šè¿‡æµè§ˆå™¨è°ƒç”¨æœ¬æœºçš„è§†é¢‘/éŸ³é¢‘è®¾å¤‡ï¼›



## å‰ç«¯è§†é¢‘æµ

## [WebRTCæ–‡æ¡£ğŸ˜Š](https://webrtcforthecurious.com/zh/docs/08-applied-webrtc/)

## webRTC

> WebRTCåç§°æºè‡ªç½‘é¡µå®æ—¶é€šä¿¡ï¼ˆWeb Real-Time Communicationï¼‰çš„ç¼©å†™ï¼Œ
>
> æ˜¯ä¸€ä¸ªæ”¯æŒç½‘é¡µæµè§ˆå™¨è¿›è¡Œå®æ—¶è¯­éŸ³å¯¹è¯æˆ–è§†é¢‘å¯¹è¯çš„æŠ€æœ¯ï¼Œæ˜¯è°·æ­Œ2010å¹´ä»¥6820ä¸‡ç¾å…ƒæ”¶è´­Global IP Solutionså…¬å¸è€Œè·å¾—çš„ä¸€é¡¹æŠ€æœ¯ã€‚

WebRTCæ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œæ—¨åœ¨èƒ½æä¾›ç®€å•çš„ JavaScriptæ¥å£æ¥ä½¿å¾—æµè§ˆå™¨è·å¾—å®æ—¶é€šä¿¡ï¼ˆRTCï¼‰èƒ½åŠ›ã€‚

WebRTCä¸ä»…å¯ä¼ è¾“è§†é¢‘**ï¼Œ**ä¹Ÿå¯ä»¥ä¼ è¾“å…¶ä»–æ•°æ®ä¾‹å¦‚æ–‡æœ¬ã€å›¾ç‰‡ç­‰ã€‚

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWebRTCå¹¶ä¸æ˜¯æµè§ˆå™¨çš„ä¸€ä¸ªå­é›†ï¼Œæµè§ˆå™¨åªæ˜¯æ ¹æ® WebRTC çš„æ ‡å‡†åè®®å®ç°äº† WebRTCçš„åŸç”Ÿæ¥å£ã€‚Android å’Œ IOS ç³»ç»Ÿä¹Ÿæ”¯æŒ WebRTC ã€‚

webRTCä¸»è¦å†…å®¹æ¶µç›–ï¼š

- **ä¿¡ä»¤æœåŠ¡å™¨ï¼ˆSignalling serversï¼‰**
- **ICEæœåŠ¡å™¨ï¼ˆICE serversï¼‰**
- **åª’ä½“æœåŠ¡å™¨ï¼ˆMedia serversï¼‰**
- **JavaScriptæ¥å£ ï¼ˆJavaScript APIï¼‰**

å¸¸è§é€šä¿¡æµç¨‹ï¼š

WebRTCå½“é€šè¿‡ä¿¡ä»¤serveräº¤æ¢å®Œsdp, candidateåï¼Œå†ä¾é ICEæ¡†æ¶æœåŠ¡å™¨åœ¨2ç«¯ä¹‹é—´å»ºç«‹ä¸€ä¸ªé€šé“ã€‚

- ä¸€æ–¹å‘èµ·è°ƒç”¨ getUserMedia æ‰“å¼€æœ¬åœ°æ‘„åƒå¤´
- åª’ä½“åå•†ï¼ˆä¿¡ä»¤äº¤æ¢ï¼‰
- ICEå»ºç«‹é€šä¿¡



## ä¿¡ä»¤æœåŠ¡å™¨ï¼ˆSignalling serversï¼‰

> ä¿¡ä»¤é€šå¸¸æŒ‡çš„æ˜¯ä¸ºäº†ç½‘ç»œä¸­å„ç§è®¾å¤‡åè°ƒè¿ä½œï¼Œåœ¨è®¾å¤‡ä¹‹é—´ä¼ é€’çš„æ§åˆ¶ä¿¡æ¯ã€‚
>
> WebRTC å¹¶æ²¡æœ‰è§„å®šä¿¡ä»¤å¿…é¡»ä½¿ç”¨ä½•ç§å®ç°ï¼Œç›®å‰ä¸šç•Œä½¿ç”¨è¾ƒå¤šçš„æ˜¯ WebSocket + JSON/SDP çš„æ–¹æ¡ˆã€‚å…¶ä¸­ **WebSocket** ç”¨æ¥æä¾›ä¿¡ä»¤ä¼ è¾“é€šé“ï¼ŒJSON/SDP ç”¨æ¥å°è£…ä¿¡ä»¤çš„å…·ä½“å†…å®¹ã€‚

ä¿¡ä»¤æœåŠ¡å™¨ä¸»è¦ç”¨äºåœ¨ä¸¤ä¸ªç”¨æˆ·ä¹‹é—´äº¤æ¢ä¿¡æ¯ã€‚è™½ç„¶WebRTCæ˜¯ç‚¹å¯¹ç‚¹é€šä¿¡ï¼Œä½†è¿˜æ˜¯éœ€è¦æœåŠ¡å™¨æ¥åˆå§‹åŒ–è¿æ¥ï¼Œå¹¶ä¼ é€’ä¸€äº›åˆå§‹åŒ–æ‰€éœ€çš„ä¿¡æ¯ã€‚

**ä¿¡ä»¤æœåŠ¡å™¨ä½œç”¨ä¸»è¦æœ‰**ï¼š

1. **åå•†åª’ä½“åŠŸèƒ½å’Œè®¾ç½®** ã€*ä¸»è¦ä½œç”¨*ã€‘
2. æ ‡è¯†å’ŒéªŒè¯ä¼šè¯å‚ä¸è€…çš„èº«ä»½ ã€*ä¸šåŠ¡åœºæ™¯*ã€‘
3. æ§åˆ¶åª’ä½“ä¼šè¯ã€æŒ‡ç¤ºè¿›åº¦ã€æ›´æ”¹ä¼šè¯å’Œç»ˆæ­¢ä¼šè¯ã€*ä¸šåŠ¡åœºæ™¯*ã€‘

### ä»€ä¹ˆæ˜¯åª’ä½“åå•†

åª’ä½“åå•†å°±æ˜¯åœ¨**äº¤æ¢ SDP**çš„è¿‡ç¨‹ã€‚

ä¼šè¯å‘èµ·è€…é€šè¿‡åˆ›å»ºä¸€ä¸ª`offer`ï¼Œç»è¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€åˆ°æ¥æ”¶æ–¹ï¼Œæ¥æ”¶æ–¹åˆ›å»º`answer`å¹¶è¿”å›ç»™å‘é€æ–¹ï¼Œå®Œæˆäº¤æ¢ã€‚

> **SDP**ï¼š
>
> SDPï¼ˆSession Description Protocolï¼‰æŒ‡**ä¼šè¯æè¿°åè®®**ï¼Œæ˜¯ä¸€ç§é€šç”¨çš„åè®®ã€‚
>
> ä¸»è¦ç”¨æ¥æè¿°å¤šåª’ä½“ä¼šè¯ï¼Œç”¨é€”åŒ…æ‹¬ä¼šè¯å£°æ˜ã€ä¼šè¯é‚€è¯·ã€ä¼šè¯åˆå§‹åŒ–ç­‰ã€‚
>
> **é€šä¿—æ¥è®²ï¼Œå®ƒå¯ä»¥è¡¨ç¤ºå„ç«¯çš„èƒ½åŠ›ï¼Œè®°å½•æœ‰å…³äºä½ éŸ³é¢‘ç¼–è§£ç ç±»å‹ã€ç¼–è§£ç å™¨ç›¸å…³çš„å‚æ•°ã€ä¼ è¾“åè®®ç­‰ä¿¡æ¯ã€‚**
>
> äº¤æ¢ SDP æ—¶ï¼Œé€šä¿¡çš„åŒæ–¹ä¼šå°†æ¥æ”¶åˆ°çš„ SDP å’Œè‡ªå·±çš„ SDP è¿›è¡Œæ¯”è¾ƒï¼Œå–å‡ºä»–ä»¬ä¹‹é—´çš„äº¤é›†ï¼Œè¿™ä¸ªäº¤é›†å°±æ˜¯åå•†çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆåŒæ–¹éŸ³è§†é¢‘é€šä¿¡æ—¶ä½¿ç”¨çš„éŸ³è§†é¢‘å‚æ•°åŠä¼ è¾“åè®®ã€‚

### offerå’Œanswer

åœ¨åŒæ–¹è¦å»ºç«‹ç‚¹å¯¹ç‚¹é€šä¿¡æ—¶:

- å‘èµ·ç«¯å‘é€çš„ SDP æ¶ˆæ¯ç§°ä¸º Offer
- æ¥æ”¶ç«¯å‘é€çš„ SDP æ¶ˆæ¯ç§°ä¸º Answer

æ‰€ä»¥ï¼Œoffer å’Œ answer æœ¬è´¨å°±æ˜¯å­˜æœ‰ SDP ä¿¡æ¯çš„å¯¹è±¡ï¼Œæ‰€ä»¥ä¹Ÿä¼šå«åš SDP Offer å’Œ SDP Answerã€‚



## ICEæœåŠ¡å™¨

> ICEï¼ˆInteractive Connectivity Establishmentï¼‰äº¤äº’å¼è¿æ¥å»ºç«‹
>
> ICE ä¸æ˜¯ä¸€ç§åè®®ï¼Œä»–æ˜¯æ•´åˆäº† STUN å’Œ TURN ä¸¤ç§åè®®ï¼ˆç”¨äº NAT ç©¿é€ï¼‰çš„æ¡†æ¶ã€‚

å½“åª’ä½“åå•†å®Œæˆåï¼ŒWebRTC å°±å¼€å§‹å»ºç«‹ç½‘ç»œè¿æ¥ï¼Œå…¶è¿‡ç¨‹ç§°ä¸º ICEã€‚

ICE æ˜¯åœ¨å„ç«¯è°ƒç”¨ setLocalDescription() åå°±å¼€å§‹äº†ï¼Œå…¶æ“ä½œè¿‡ç¨‹å¦‚ä¸‹ï¼š

1. æ”¶é›† Candidate
2. äº¤æ¢ Candidate
3. æŒ‰ä¼˜å…ˆçº§å°è¯•è¿æ¥

> **Candidate**
>
> Candidate æ˜¯è‡³å°‘åŒ…æ‹¬ IP åœ°å€ã€ç«¯å£å·ã€åè®®çš„ä¸€ä¸ªä¿¡æ¯é›†ã€‚
>
> å› ä¸ºæ¯”å¦‚æƒ³ç”¨ socket è¿æ¥æŸå°æœåŠ¡å™¨ï¼Œä¸€å®šè¦çŸ¥é“è¿™å°æœåŠ¡å™¨çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ï¼Œå¦‚æœåŠ¡å™¨çš„ IP åœ°å€ã€ç«¯å£å·ä»¥åŠä½¿ç”¨çš„ä¼ è¾“åè®®ã€‚åªæœ‰çŸ¥é“äº†è¿™äº›ä¿¡æ¯ï¼Œæ‰èƒ½ä¸è¿™å°æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚
>
> è€Œ Candidate æ­£æ˜¯ WebRTC ç”¨æ¥æè¿°å®ƒå¯ä»¥è¿æ¥çš„è¿œç«¯çš„åŸºæœ¬ä¿¡æ¯ï¼Œ

### æ”¶é›†Candidate

åœ¨ WebRTC ä¸­æœ‰ä¸‰ç§ç±»å‹çš„ **ICE å€™é€‰è€…ï¼ˆCandidateï¼‰**ï¼Œä¼˜å…ˆçº§é€’å‡ï¼š

1. **ä¸»æœºå€™é€‰è€…**ï¼š

   è¡¨ç¤ºç½‘å¡è‡ªå·±çš„ IP åœ°å€åŠç«¯å£ã€‚é€šè¿‡è®¾å¤‡ç½‘å¡è·å–ï¼Œä¼˜å…ˆçº§æœ€é«˜ã€‚åœ¨ WebRTC åº•å±‚é¦–å…ˆä¼šå°è¯•æœ¬åœ°å±€åŸŸç½‘å†…å»ºç«‹è¿æ¥ã€‚

2. **åå°„å€™é€‰è€…**ï¼š

   è¡¨ç¤ºç»è¿‡ NAT ä¹‹åçš„å¤–ç½‘ IP åœ°å€å’Œç«¯å£ï¼Œç”± ICEï¼ˆSTUNï¼‰æœåŠ¡å™¨è·å–ï¼Œæ ¹æ®æœåŠ¡å™¨çš„è¿”å›æƒ…å†µï¼Œæ¥ç»¼åˆåˆ¤æ–­å¹¶çŸ¥é“è‡ªèº«åœ¨å…¬ç½‘ä¸­çš„åœ°å€ã€‚å…¶ä¼˜å…ˆçº§ä½äºä¸»æœºå€™é€‰è€…ï¼Œå½“ WebRTC å°è¯•æœ¬åœ°è¿æ¥ä¸é€šæ—¶ï¼Œä¼šå°è¯•é€šè¿‡åå°„å€™é€‰è€…è·å¾—çš„ IP åœ°å€å’Œç«¯å£è¿›è¡Œè¿æ¥ã€‚

3. **ä¸­ç»§å€™é€‰è€…**ï¼š

   è¡¨ç¤ºçš„æ˜¯ä¸­ç»§(TURN)æœåŠ¡å™¨çš„è½¬å‘ IP åœ°å€ä¸ç«¯å£ï¼Œç”± ICE ä¸­ç»§æœåŠ¡å™¨æä¾›ã€‚ä¼˜å…ˆçº§æœ€ä½ï¼Œå‰ä¸¤ä¸ªéƒ½ä¸è¡Œåˆ™ä¼šæŒ‰è¯¥ç§æ–¹å¼ã€‚

åœ¨æ–°å»º`RTCPeerConnection`æ—¶å¯åœ¨æ„é€ å‡½æ•°æŒ‡å®š ICE æœåŠ¡å™¨åœ°å€ï¼Œæ²¡æœ‰æŒ‡å®šçš„è¯åˆ™æ„å‘³ç€è¿™ä¸ªè¿æ¥åªèƒ½åœ¨å†…ç½‘è¿›è¡Œã€‚

æ¯æ¬¡ WebRTC æ‰¾åˆ°/æ”¶é›†ä¸€ä¸ªå¯ç”¨çš„ Candidateï¼Œéƒ½ä¼šè§¦å‘ä¸€æ¬¡`icecandidate`äº‹ä»¶ï¼Œä¸ºäº†å°†æ”¶é›†åˆ°çš„ Candidate äº¤æ¢ç»™å¯¹ç«¯ï¼Œéœ€è¦ç»™`onicecandidate`æ–¹æ³•è®¾ç½®ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå‡½æ•°é‡Œé¢è°ƒç”¨`addIceCandidate`æ–¹æ³•æ¥å°†å€™é€‰è€…æ·»åŠ åˆ°é€šä¿¡ä¸­ã€‚

### äº¤æ¢Candidate

WebRTC æ”¶é›†å¥½ Candidate åï¼Œä¼šé€šè¿‡ä¿¡ä»¤ç³»ç»Ÿå°†å®ƒä»¬å‘é€ç»™å¯¹ç«¯ã€‚

å¯¹ç«¯æ¥æ”¶åˆ°è¿™äº› Candidate åï¼Œä¼šä¸æœ¬åœ°çš„ Candidate å½¢æˆ CandidatePairï¼ˆå³è¿æ¥å€™é€‰è€…å¯¹ï¼‰ã€‚

æœ‰äº† CandidatePairï¼ŒWebRTC å°±å¯ä»¥å¼€å§‹å°è¯•å»ºç«‹è¿æ¥äº†ã€‚

> CandidatePairï¼Œå€™é€‰è€…å¯¹ï¼Œå³ä¸€ä¸ªæœ¬åœ° Candidateï¼Œä¸€ä¸ªè¿œç«¯ Candidate

å½“ WebRTC å½¢æˆ CandidatePair åï¼Œä¾¿å¼€å§‹å°è¯•è¿›è¡Œè¿æ¥ã€‚ä¸€æ—¦ WebRTC å‘ç°å…¶ä¸­æœ‰ä¸€ä¸ªå¯ä»¥è¿é€šçš„ CandidatePair æ—¶ï¼Œå®ƒå°±ä¸å†è¿›è¡Œåé¢çš„è¿æ¥å°è¯•äº†ï¼Œä½†å‘ç°æ–°çš„ Candidate æ—¶ä»ç„¶å¯ä»¥ç»§ç»­è¿›è¡Œäº¤æ¢ã€‚

### STUN

STUNï¼ˆSession Traversal Utilities for NAT, NAT ä¼šè¯ç©¿è¶Šåº”ç”¨ç¨‹åºï¼‰ã€‚å®ƒå…è®¸ä½äº NATï¼ˆæˆ–å¤šé‡ NATï¼‰åçš„å®¢æˆ·ç«¯æ‰¾å‡ºè‡ªå·±å¯¹åº”çš„å…¬ç½‘ IP åœ°å€å’Œç«¯å£ï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„"æ‰“æ´"/"NAT æ‰“æ´"/"NAT ç©¿è¶Š"ã€‚

å†ç›´ç™½ç‚¹ï¼Œ**STUN æœåŠ¡å™¨ç”¨äºè·å–è®¡ç®—æœºçš„å…¬ç½‘ IP åœ°å€ã€‚**

> Google æä¾›äº†ä¸€ä¸ªæµ‹è¯• STUN/TURN æœåŠ¡çš„[ç½‘å€](https://link.juejin.cn/?target=https%3A%2F%2Fwebrtc.github.io%2Fsamples%2Fsrc%2Fcontent%2Fpeerconnection%2Ftrickle-ice%2F)ï¼Œå¯ä»¥æµ‹è¯•å¯¹åº”çš„ STUN æœåŠ¡ã€‚

æ‰“æ´çš„æœºåˆ¶å« ICEï¼Œè€Œå¸®å¿™æ‰“æ´çš„æœåŠ¡å™¨å« STUN æœåŠ¡ã€‚

åœ¨ä¸¤ä¸ªç”¨æˆ·é€šä¿¡å‰ï¼š

- é¦–å…ˆä¼šå‘å…¬ç½‘çš„ STUN æœåŠ¡å‘é€è¯·æ±‚è·å–è‡ªå·±çš„å…¬ç½‘åœ°å€
- ç„¶åé€šè¿‡æœåŠ¡å™¨å°†å„è‡ªçš„å…¬ç½‘åœ°å€è½¬å‘ç»™å¯¹ç­‰ç«¯ï¼Œè¿™æ ·åŒæ–¹å°±çŸ¥é“äº†å¯¹æ–¹çš„å…¬ç½‘åœ°å€
- æ ¹æ®è¿™ä¸ªå…¬ç½‘åœ°å€å°±å¯ä»¥ç›´æ¥ç‚¹å¯¹ç‚¹é€šä¿¡äº†

> å½“ STUN æœåŠ¡é‡åˆ°å¯¹ç§°å‹ NAT æ—¶ï¼ˆè¿™é‡Œå¦‚æœä¸æ‡‚å…ˆå»äº†è§£ [NAT ç›¸å…³çš„åŸºç¡€çŸ¥è¯†](https://sspai.com/post/68037)ï¼‰ï¼Œå°±æ‰“æ´å¤±è´¥äº†ï¼Œè¿™æ—¶å°±éœ€è¦ TURN æœåŠ¡ã€‚

### TURN

**TURN**(Traversal USing Replays around NAT)ï¼Œå³ä½¿ç”¨ä¸­ç»§ç©¿é€ NATï¼Œæ˜¯ STUN çš„æ‰©å±•ã€‚

å¦‚æœ STUN åˆ†é…å…¬ç½‘ IP çš„æ–¹å¼å¤±è´¥ï¼Œåˆ™å¯ä»¥é€šè¿‡ TURN æœåŠ¡å™¨è¯·æ±‚å…¬ç½‘ IP åœ°å€ä½œä¸ºä¸­ç»§åœ°å€ï¼Œå°†åª’ä½“æ•°æ®é€šè¿‡ TURN æœåŠ¡å™¨è¿›è¡Œä¸­è½¬ï¼Œç”¨ä½œ**å¯¹ç­‰è¿æ¥å¤±è´¥çš„ä¸­ç»§**ï¼Œå±äºæœ€ç»ˆçš„å¤‡é€‰æ–¹å¼ã€‚

ç›®çš„å°±æ˜¯**è§£å†³å¯¹ç§° NAT æ— æ³•ç©¿è¶Šçš„é—®é¢˜**ï¼Œä¸åŒäºå…¶å®ƒä¸­ç»§åè®®åœ¨äºå®ƒå…è®¸å®¢æˆ·æœºä½¿ç”¨ä¸€ä¸ªä¸­ç»§åœ°å€ä¸å¤šä¸ªå¯¹ç«¯åŒæ—¶è¿›è¡Œé€šè®¯ã€‚å®Œç¾å¼¥è¡¥äº† STUN æ— æ³•ç©¿è¶Šå¯¹ç§°å‹ NAT çš„é—®é¢˜ã€‚

ä¸`STUN`æœåŠ¡å™¨ä¸åŒçš„æ˜¯ï¼ŒTURN æœåŠ¡å™¨ä¼šä½œä¸ºä¸­è½¬ï¼Œè½¬å‘å¤šåª’ä½“æ•°æ®ä¼šæ¶ˆè€—å¤§é‡çš„å¸¦å®½ã€‚

**æ‰€ä»¥ICE æ‰“æ´ç›¸å…³çš„è¿‡ç¨‹ï¼Œå¼€å‘è€…åªéœ€é…ç½®å¥½ STUN/TURN å¯¹åº”çš„åœ°å€ï¼Œåœ¨å¯¹åº”çš„å‡½æ•°è°ƒç”¨å°±å¯ä»¥äº†ï¼ŒWebRTC åœ¨åº•å±‚å¸®æˆ‘ä»¬å»å®ç°äº†ã€‚**



> å‚è€ƒèµ„æ–™ï¼š
>
> - [è¯¦è§£webRTC](https://juejin.cn/post/7079630486854696968)







## JavaScriptæ¥å£

- #### getUserMedia

  é€šè¿‡è°ƒç”¨navigator.getUserMedia()å¯ä»¥è·å–è§†é¢‘æˆ–éŸ³é¢‘çš„æ•°æ®ï¼Œconstraints å‚æ•°å¯ä»¥é€‰æ‹©æ˜¯å¦è·å–è§†é¢‘éŸ³é¢‘ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹

  ```
  var constraints = {
    audio: true,
    video: true
  };
  var video = document.querySelector('video');
  
  navigator.mediaDevices.getUserMedia(constraints)
  .then(function(stream) {
    /* ä½¿ç”¨è¿™ä¸ª stream stream */
    video.srcObject = stream;
  })
  
  ```

- #### RTCPeerConnection

  RTCPeerConnectionæ˜¯WebRTCä¸­æœ€é‡è¦çš„ä¸€ä¸ªæ¥å£ï¼Œç”¨äºç¡®å®šICEæœåŠ¡å™¨ã€äº¤æ¢ SDPã€‚

  [è¯¦æƒ…æŸ¥çœ‹MDN](https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection)





### MediaStream

[è¯¦è§£MediaStream](https://juejin.cn/post/6932973267049250829)











## æ­å»ºSTUN/TURNæœåŠ¡å™¨

> å‚è€ƒï¼š
>
> [coturné…ç½®é¡¹ä»‹ç»](http://quanzhan.applemei.com/webStack/TlRZNE5RPT0=)

ä½¿ç”¨coturnæ¡†æ¶

å¸¸ç”¨å‘½ä»¤

- `turnserver -c /etc/coturn/turnserver.conf -o`

  ```shell
  # è¿™é‡Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼ŒæˆåŠŸå¯åŠ¨æœåŠ¡
  turnserver -v -r  8.140.151.101:3478 -a -o -c /etc/coturn/turnserver.conf
  ```

  è¿è¡ŒæœåŠ¡

- [å¸¸ç”¨coturné…ç½®](https://blog.csdn.net/rannar/article/details/125503200)

- `service restart coturn`

  é‡å¯æœåŠ¡

- `systemctl status coturn`

  æŸ¥çœ‹çŠ¶æ€



### coturné…ç½®æ–‡ä»¶

```shell
# ç›‘å¬ç«¯å£ é»˜è®¤3478
listening-port=3478
# å¤–ç½‘åœ°å€ æœåŠ¡å™¨å…¬ç½‘åœ°å€
external-ip=8.140.151.101
# å†…ç½‘åœ°å€ é€šè¿‡ifconfig æŸ¥çœ‹
listening-ip=172.23.10.94
# turnæœåŠ¡å™¨ ç”¨æˆ·åï¼šå¯†ç 
user=jfred:123451
# éšæ„è®¾ç½®ï¼Œå¦åˆ™å¯åŠ¨æœåŠ¡ä¼šè­¦å‘Š
cli-password=qwerty
# ç«¯å£èŒƒå›´ï¼Œè¿™ä¸ªä¸æœåŠ¡å™¨å®‰å…¨ç»„è¦åŒæ­¥å¼€æ”¾
min-port=49152
max-port=65535
# å¿…å¡«ï¼Œæ²¡æœ‰åŸŸåå°±ä½¿ç”¨å¤–ç½‘IP
realm=8.140.151.101
# è¯ä¹¦éå¿…å¡«ï¼Œå¯ä»¥åœ¨æœåŠ¡å™¨ç«¯æ‰‹åŠ¨ç”Ÿæˆã€‚ åè®®ä½¿ç”¨DTLS å®‰å…¨é€šä¿¡
cert=/etc/turn_server_cert.pem
pkey=/etc/turn_server_pkey.pem
```







## WebRTCå®è·µ

### ç›®æ ‡

å®ç°è§†é¢‘/éŸ³é¢‘èŠå¤©å®¤æ­å»ºï¼Œæ”¯æŒ2+å¤šäººåŒæ—¶å‚ä¸ã€‚



### è®¡åˆ’

1. å‰ç«¯`Vue 3 + Socket.io`ï¼Œ åç«¯`Koa 2 + WebRTC + Socket.io`ï¼›
2. æ­å»ºåŸºç¡€è§†é¢‘/éŸ³é¢‘åŠŸèƒ½ï¼Œä»£ç åŸºç¡€æ­å»ºï¼›
3. å®ç°æˆ¿é—´åŠŸèƒ½ï¼Œå¯éšæœºåŠ å…¥å·²æœ‰æˆ¿é—´ï¼›
4. ç•Œé¢ä¼˜åŒ–ï¼›







