## 邮箱验证

用户注册后，需要实时进行邮箱验证（筛除垃圾账号）；

流程应为：

- ### 注册流程

1. 用户注册后，完成后台注册接口后，

   直接跳转到邮箱验证页，强制进行 验证邮箱；

   此时用户 已存在数据库中，但属于**未验证账号**；

   ```
   - 这里注册成功后，即将用户账号信息，存储在客户端内存中（vuex）
   - 跳转到邮箱验证页，将内存中的用户信息发送后台，后台校验用户是否合法（是否注册）;
   - 验证通过后，给注册用户邮箱发送验证链接；
   ```

2. 邮箱验证会发送一个包含用户信息的`验证token链接`，点击后携带token会跳转到本系统的完成验证页面;

   系统会用链接过来的token，自动发请求验证，获取当前用户的`excess_token`，存储在客户端；

   ```
   - 完成验证页面获取excess_token后，就等同于已登录；
   - 验证成功后，默认几秒内跳转首页，完成邮箱验证；
   ```

3. 此前注册自动跳转的**邮箱验证页**包含`确认已激活`按钮，点击目标的前端路由为系统首页；

   ```
   - 这里用户点击按钮前，若已成功验证邮箱，则用户状态为正常（已验证 EMAIL_IVERIFY）
     并且客户端浏览器已经保存了token，所以点击按钮就可进入系统；
   ```

   



- ### 登录流程

  > - access_token  
  >
  > 访问token，可访问系统内所有资源接口
  >
  > - email_token  
  >
  > 邮箱验证token，在邮件中发送，用来验证用户邮箱合法性；
  >
  > - send_email_token  
  >
  > 发送验证邮件的权限token，为避免滥发邮件接口，需要登陆后携带此token申请接受邮件
  >
  > **[限制只有登录用户，才有权限发送验证邮件]**

1. 如未完成邮箱验证，再次登录此账号时，仍重定向至邮箱验证页面；

   页面中包含`重新发送邮件`按钮; 点击发送按钮，执行同注册相同逻辑；

   ```
   - 登录时查询用户信息后，如未验证邮箱，不返回token, 只返回用户相关已注册信息(包括send_email_token)；
   - 同样的验证邮箱页面，区分来自于 登录页 / 注册页；
     [用户申请发送验证邮件，需要带上send_email_token]
     注册页直接发送邮件接口；
     登录页需要用户手动操作；
   - 只有当用户点击邮箱链接，将自己的用户状态改为已验证；
     返回页面后，才能进入页面；
   ```

   

2. 当用户完成邮箱验证后，刷新用户已验证状态，参照注册流程颁发token，进入系统页面；

### 邮箱验证

可暂使用`sendCloud`邮箱服务，免费额度10封/天，可供测试使用；

> `sendCloud`网址： https://www.sendcloud.net/doc/email_v2/code/

