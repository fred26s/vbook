(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{375:function(s,e,a){"use strict";a.r(e);var n=a(42),t=Object(n.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"ts-中使用-nodejs-搭建后端服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ts-中使用-nodejs-搭建后端服务"}},[s._v("#")]),s._v(" TS 中使用 nodejs 搭建后端服务")]),s._v(" "),a("p",[s._v("这里记录下自己使用TypeScript + nodeJS技术栈搭建一套后台服务的流程；")]),s._v(" "),a("h2",{attrs:{id:"安装环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装环境"}},[s._v("#")]),s._v(" 安装环境")]),s._v(" "),a("h3",{attrs:{id:"express-generator"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#express-generator"}},[s._v("#")]),s._v(" express-generator")]),s._v(" "),a("p",[s._v("全局安装后，就可以直接使用"),a("code",[s._v("express")]),s._v("命令")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm i express-generator -g\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"初始化项目结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始化项目结构"}},[s._v("#")]),s._v(" 初始化项目结构")]),s._v(" "),a("p",[s._v("使用"),a("code",[s._v("express")]),s._v("命令创建项目结构")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("express --view=jade XXXX\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("生成的项目包含这些内容：")]),s._v(" "),a("ul",[a("li",[s._v("bin")]),s._v(" "),a("li",[s._v("public")]),s._v(" "),a("li",[s._v("routes")]),s._v(" "),a("li",[s._v("views")]),s._v(" "),a("li",[s._v("-app.js")]),s._v(" "),a("li",[s._v("-package.json")])]),s._v(" "),a("h3",{attrs:{id:"新增项目结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#新增项目结构"}},[s._v("#")]),s._v(" 新增项目结构")]),s._v(" "),a("p",[s._v("新增一些项目必须的文件夹结构；")]),s._v(" "),a("ul",[a("li",[s._v("config 存放配置文件")]),s._v(" "),a("li",[s._v("controller 接口逻辑")]),s._v(" "),a("li",[s._v("model 数据库相关")]),s._v(" "),a("li",[s._v("types 第三方库声明文件")]),s._v(" "),a("li",[s._v("utils 工具函数")])]),s._v(" "),a("h3",{attrs:{id:"安装依赖"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装依赖"}},[s._v("#")]),s._v(" 安装依赖")]),s._v(" "),a("p",[s._v("先安装初始化项目"),a("code",[s._v("package.json")]),s._v("中默认依赖的包；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm i\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("安装"),a("code",[s._v("typescript")]),s._v("；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm i typescript -D\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("因为在"),a("code",[s._v("ts")]),s._v("中开发 node，所以安装"),a("code",[s._v("node")]),s._v("以及"),a("code",[s._v("express")]),s._v("框架的声明文件；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm i @types/express @types/node -D\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"修改目录结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改目录结构"}},[s._v("#")]),s._v(" 修改目录结构")]),s._v(" "),a("h3",{attrs:{id:"修改所有-js-文件为-ts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改所有-js-文件为-ts"}},[s._v("#")]),s._v(" 修改所有.js 文件为.ts")]),s._v(" "),a("p",[s._v("因为我们要使用 ts 来写 node 项目，所以先将初始化项目中所有"),a("code",[s._v(".js")]),s._v("文件修改为"),a("code",[s._v(".ts")]),s._v("；")]),s._v(" "),a("p",[s._v("具体有：")]),s._v(" "),a("ul",[a("li",[s._v("bin 中的"),a("code",[s._v("www")]),s._v(" ，挪至根目录，修改为"),a("code",[s._v("server.ts")])]),s._v(" "),a("li",[s._v("根目录的"),a("code",[s._v("app.js")]),s._v("，修改为"),a("code",[s._v("app.ts")])]),s._v(" "),a("li",[a("code",[s._v("routes")]),s._v("路由目录下，修改路由文件为"),a("code",[s._v(".ts")])])]),s._v(" "),a("p",[s._v("修改完成后项目结构为：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("- public\n- routes\n- types\n- views\n- -app.ts\n- -package.json\n- -server.ts\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"配置-tsconfig-json"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-tsconfig-json"}},[s._v("#")]),s._v(" 配置 tsconfig.json")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("outDir")]),s._v(" "),a("p",[s._v("修改输出目录为"),a("code",[s._v("./dist")]),s._v("文件夹")])]),s._v(" "),a("li",[a("p",[s._v("moduleResolution")]),s._v(" "),a("p",[s._v("选择模块解析策略，为"),a("code",[s._v("node")]),s._v("；")])]),s._v(" "),a("li",[a("p",[s._v("baseUrl")]),s._v(" "),a("p",[s._v("基础为"),a("code",[s._v(".")])])]),s._v(" "),a("li",[a("p",[s._v("path")]),s._v(" "),a("p",[a("code",[s._v('"*": ["node_modules/*", "./types/*"]')])])])]),s._v(" "),a("h3",{attrs:{id:"配置-package-json"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置-package-json"}},[s._v("#")]),s._v(" 配置 package.json")]),s._v(" "),a("p",[s._v("先配置脚本文件")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('"scripts": {\n    "start": "npm run serve",\n    // 启动服务\n    "serve": "node ./dist/server.js",\n    // 打包\n    "build": "tsc && node ./handle-public.js",\n    // cross-env NODE_ENV=develop 表示当环境变量是develop时\n    // nodemon 相当于Node中的热更新插件 -e 表示指定检测的文件类型为ts, tsx\n    // --exec 表示nodemon将监视和执行的文件 后面跟着 ./server.ts\n    // ts-node 是因为nodemon只能执行js文件，所以使用这个插件，可以在node环境执行ts文件\n    "dev": "cross-env NODE_ENV=develop nodemon -e ts, tsx --exec \'ts-node\' ./server.ts"\n},\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("h2",{attrs:{id:"启动服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#启动服务"}},[s._v("#")]),s._v(" 启动服务")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm run dev\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("okay，现在已经成功启动"),a("code",[s._v("express")]),s._v("服务了。")]),s._v(" "),a("h2",{attrs:{id:"安装-mysql-库"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装-mysql-库"}},[s._v("#")]),s._v(" 安装 mysql 库")]),s._v(" "),a("p",[s._v("npm 安装 mysql 模块和声明文件，用来连接操作数据库")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm i mysql -S\nnpm i @types/mysql -D\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"新增-mysql-配置文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#新增-mysql-配置文件"}},[s._v("#")]),s._v(" 新增 Mysql 配置文件")]),s._v(" "),a("p",[s._v("在根目录新增"),a("code",[s._v("config")]),s._v("文件夹，存放项目配置文件，并新增子文件"),a("code",[s._v("mysql.config.ts")]),s._v("来管理数据库配置；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("const devConfig = {\n  host: 'localhost',\n  database: 'ts',\n  user: 'root',\n  password: '666666'\n}\n\nconst prodConfig = {\n  host: '192.168.0.1',\n  database: 'ts',\n  port: 3306\n}\n\nmodule.exports = process.env.NODE_ENV === 'development' ? devConfig : prodConfig\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h2",{attrs:{id:"划分mvc架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#划分mvc架构"}},[s._v("#")]),s._v(" 划分MVC架构")]),s._v(" "),a("h3",{attrs:{id:"model-层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#model-层"}},[s._v("#")]),s._v(" model 层")]),s._v(" "),a("p",[s._v("在根目录新增"),a("code",[s._v("model")]),s._v("文件夹，存放数据层文件；")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("新增子文件"),a("code",[s._v("index.ts")]),s._v("来连接数据库，并导出 sql 实例；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("import mysql = require('mysql')\nconst mysqlConfig = require('../config/mysql.config')\n\nconst sql = mysql.createConnection(mysqlConfig)\nsql.connect()\n\nexport = sql\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("新增文件夹"),a("code",[s._v("tables")]),s._v("，来管理表，具体的表 sql 语句都放在这个文件夹内")]),s._v(" "),a("p",[s._v("-model")]),s._v(" "),a("p",[s._v("-tables")])])]),s._v(" "),a("h3",{attrs:{id:"业务-sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#业务-sql"}},[s._v("#")]),s._v(" 业务 sql")]),s._v(" "),a("p",[s._v("我们现在创建一个"),a("code",[s._v("image")]),s._v("表，就在"),a("code",[s._v("tables")]),s._v("目录下新建"),a("code",[s._v("image.ts")]),s._v("，来存放 sql；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("module.exports = sql => {\n  sql.query(\n    'SELECT table_name FROM information_schema.TABLES WHERE table_name =\"image\"',\n    (err, res) => {\n      if (res && res.length) return                  // 如果没有此表，就创建\n      sql.query(`CREATE TABLE \\`image\\` (\n            \\`id\\` INT NOT NULL AUTO_INCREMENT,\n            \\`file_key\\` VARCHAR(45) NOT NULL,\n            \\`file_name\\` VARCHAR(45) NOT NULL,\n            PRIMARY KEY (\\`id\\`))`)\n    }\n  )\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[a("code",[s._v("image.ts")]),s._v("暴露出的是一个函数，内部包含具体的 sql 逻辑语句；")]),s._v(" "),a("p",[s._v("将此 sql 引入"),a("code",[s._v("tables-index.ts")]),s._v(" 文件，绑定在 sql 实例上；")]),s._v(" "),a("p",[s._v("这样就可以将所有具体的业务 sql 文件都引入到这个"),a("code",[s._v("index.ts")]),s._v("中，最终暴露给"),a("code",[s._v("server.ts")]),s._v("这一个文件即可；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("----------tables内 index.ts----------------\nimport mysql = require('mysql')\nconst mysqlConfig = require('../config/mysql.config')\n\nconst sql = mysql.createConnection(mysqlConfig)\nsql.connect()                                    // 连接数据库\nrequire('./tables/image')(sql)                  // 用实例执行具体业务sql语句\n\nexport = sql\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("将"),a("code",[s._v("model")]),s._v("层"),a("code",[s._v("index.ts")]),s._v("，暴露给"),a("code",[s._v("server.ts")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("var app = require('./app')\nvar debug = require('debug')('service:server')\nvar http = require('http')\nrequire('./model')                  // 暴露index.ts\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"views-层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#views-层"}},[s._v("#")]),s._v(" views 层")]),s._v(" "),a("p",[s._v("在"),a("code",[s._v("app.ts")]),s._v("中，可以指定视图页面文件夹；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("app.set('views', path.join(__dirname, 'views'));   // 默认使用根目录`views`文件夹\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("所以我们在根目录的"),a("code",[s._v("views")]),s._v("文件夹就可以新建一个视图页面，这里我们使用的是"),a("code",[s._v("jade")]),s._v("模板；")]),s._v(" "),a("p",[s._v("-views")]),s._v(" "),a("p",[s._v("-upload.jade")]),s._v(" "),a("p",[s._v("在新建的模板中使用"),a("code",[s._v("jade")]),s._v("语法创建 HTML；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("extends layout\n\nblock content\n  h1 this is fred's world! :)\n  h1 And The Awesome Day.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("然后我们在路由文件中，配置对应的路由地址即可显示刚才创建的模板页面；")]),s._v(" "),a("p",[s._v("打开"),a("code",[s._v("routes - index.ts")]),s._v("，添加对应的路由：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("router.get('/upload', function(req, res, next) {\n  res.render('upload', { title: 'Express' })             // 第一个参数表示路由地址\n})\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("这里"),a("code",[s._v("render")]),s._v("函数有两个参数：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("第一个参数表示路由地址，即你在浏览器 url 中输入的地址路径；")])]),s._v(" "),a("li",[a("p",[s._v("第二个参数是传入该路由的参数；")]),s._v(" "),a("p",[s._v("这个例子中，是在页面 HEAD 中使用了 title；")])])]),s._v(" "),a("p",[s._v("然后配置好页面和路由后，我们就可以访问"),a("code",[s._v("<http://localhost:3000/upload>")]),s._v("（默认端口 3000），跳转到刚才创建的页面了。")]),s._v(" "),a("h3",{attrs:{id:"controller-层"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#controller-层"}},[s._v("#")]),s._v(" controller 层")]),s._v(" "),a("p",[s._v("现在我们准备写一个组件上传文件的案例，内容是：")]),s._v(" "),a("ol",[a("li",[s._v("页面使用"),a("code",[s._v("input")]),s._v("上传文件；")]),s._v(" "),a("li",[s._v("我们后台接受文件存储到指定文件夹；")]),s._v(" "),a("li",[s._v("将文件索引存储数据库；")])]),s._v(" "),a("p",[s._v("所以第一步在后台定义"),a("code",[s._v("api")]),s._v("接口：")]),s._v(" "),a("h3",{attrs:{id:"封装文件上传方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#封装文件上传方法"}},[s._v("#")]),s._v(" 封装文件上传方法")]),s._v(" "),a("p",[s._v("我们把具体的处理文件上传的方法封装在根目录下的"),a("code",[s._v("utils/uploadFiles.ts")]),s._v("内；")]),s._v(" "),a("p",[s._v("-utils")]),s._v(" "),a("p",[s._v("-uploadFiles.ts")]),s._v(" "),a("p",[a("strong",[s._v("先安装依赖库 formidable")])]),s._v(" "),a("blockquote",[a("p",[s._v("这个依赖库模块可以实现上传和编码图片和视频。它支持 GB 级上传数据处理，支持多种客户端数据提交。")])]),s._v(" "),a("p",[s._v("因为要接受表单形式上传的文件，并进行处理，所以需要下载依赖库；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("npm i formidable -S\nnpm i @types/formidable -D\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("然后封装使用依赖库处理文件的方法，我们把这个具体处理文件的方法封装在工具函数"),a("code",[s._v("utils")]),s._v("文件夹中：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-----------------utils / uploadFiles.ts-------------------------\n\nimport path = require('path')\nimport formidable = require('formidable')\n\nexport = req => {\n  return new Promise((resolve, reject) => {\n    const form = new formidable.IncomingForm()\n    form.encoding = 'utf-8'                                     // 文件编码\n    form.uploadDir = path.join(__dirname, '../files/')         // 上传的文件保存位置[暂定项目根目录]\n    form.keepExtensions = true                                 // 保留文件后缀\n    form.parse(req, (err, fields, files) => {\n      const { file } = files                              // 文件对象\n      if (!err) resolve(file)\n      else reject(err)\n    })\n  })\n}\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h3",{attrs:{id:"创建-controller"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建-controller"}},[s._v("#")]),s._v(" 创建 controller")]),s._v(" "),a("p",[s._v("我们具体的逻辑写在"),a("code",[s._v("controller")]),s._v("中，所以根目录新建"),a("code",[s._v("controller")]),s._v("文件夹，然后创建"),a("code",[s._v("api.ts")]),s._v("文件用来写具体逻辑：")]),s._v(" "),a("p",[s._v("-controller")]),s._v(" "),a("p",[s._v("-api.ts")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("---------------------controller / api.ts------------------------\nconst uploadFiles = require('../utils/uploadFiles')              // 引入工具函数 处理上传图片\n\nexport = {\n  upload: async (req: Express.Request) => {\n    await uploadFiles(req)                         // 同步执行工具函数\n  }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("现在写好了"),a("code",[s._v("controller")]),s._v("逻辑，我们定义一个对应的接口路由；")]),s._v(" "),a("h3",{attrs:{id:"定义接口路由"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#定义接口路由"}},[s._v("#")]),s._v(" 定义接口路由")]),s._v(" "),a("p",[s._v("首先在"),a("code",[s._v("routes")]),s._v("路由文件夹中定义"),a("code",[s._v("api.ts")]),s._v("路由文件：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-----------routes / api.ts------------\nvar express = require('express')\nvar router = express.Router()\n\n/* listing. */\nrouter.post('/files_upload', async function(req, res, next) {        // 接口地址是/files_upload\n  try {\n    await api.upload(req)                 // 调用couroller中upload逻辑\n    res.send('success~')                  // 成功就返回`success`\n  } catch (error) {\n    res.send('error! please reUpload!')\n  }\n})\n\nmodule.exports = router\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("然后在根目录"),a("code",[s._v("app.ts")]),s._v("中注册接口路由：")]),s._v(" "),a("p",[s._v("这里注册的就是一个根路由"),a("code",[s._v("api")]),s._v("，我们将刚才定义的路由接口文件，导入进来注册到"),a("code",[s._v("app")]),s._v("实例上；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("-----------app.ts------------\nvar apiRouter = require('./routes/api')             // 引入接口路由\n\napp.use('/api', apiRouter)                       // 实例注册路由\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"完成接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#完成接口"}},[s._v("#")]),s._v(" 完成接口")]),s._v(" "),a("p",[s._v("这样就定义好了一个接口路由，和对应的"),a("code",[s._v("controller")]),s._v("中处理逻辑代码；")]),s._v(" "),a("p",[s._v("最终的接口地址为"),a("code",[s._v("http://localhost:3000/api/files_upload")])]),s._v(" "),a("h3",{attrs:{id:"测试接口"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试接口"}},[s._v("#")]),s._v(" 测试接口")]),s._v(" "),a("p",[s._v("在"),a("code",[s._v("views")]),s._v("页面中，增加上传标签"),a("code",[s._v("input")]),s._v("；")]),s._v(" "),a("p",[s._v("下面示例用"),a("code",[s._v("jade")]),s._v("，增加页面上传事件，即可发送请求将上传文件保存至指定位置；")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("extends layout\n\nblock content\n  input(type=\"file\", id=\"files\")\n\n  script.\n    function uploadFiles() {\n      const input = document.getElementById('files')\n      const filesList = input.files[0];\n      const form = new FormData()\n      form.append('file', filesList)\n\n      //- AJAX\n      const url = 'http://localhost:3000/api/files_upload'\n      const xhr = new XMLHttpRequest()\n      xhr.open('post', url)\n      xhr.send(form)\n      xhr.onload = event => {\n        console.log(event.target.responseText)\n      }\n    }\n    document.getElementById('files').addEventListener('change', uploadFiles)\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])])])}),[],!1,null,null,null);e.default=t.exports}}]);