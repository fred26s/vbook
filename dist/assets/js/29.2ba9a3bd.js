(window.webpackJsonp=window.webpackJsonp||[]).push([[29],{368:function(s,a,n){"use strict";n.r(a);var r=n(42),t=Object(r.a)({},(function(){var s=this,a=s.$createElement,n=s._self._c||a;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h2",{attrs:{id:"_1-主体部署思路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-主体部署思路"}},[s._v("#")]),s._v(" 1.主体部署思路")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("本地修改代码，提交到指定分支")])]),s._v(" "),n("li",[n("p",[s._v("Travis监听仓库改变")])]),s._v(" "),n("li",[n("p",[s._v("Travis执行"),n("strong",[s._v("install")]),s._v("和"),n("strong",[s._v("script")]),s._v("任务（这里可以做一些安装测试构建任务的依赖和测试构建命令）")]),s._v(" "),n("ul",[n("li",[n("p",[s._v("install: # 在安装项目环境阶段需要运行的命令，一条一行，类似的还有 before_install")])]),s._v(" "),n("li",[n("p",[s._v("script: # 在构建阶段需要运行的命令，一条一行，类似的还有 before_script、after_script")])])])]),s._v(" "),n("li",[n("p",[s._v("任务执行成功后，在Travis的 "),n("strong",[s._v("after_success")]),s._v(" 钩子里面用 "),n("em",[s._v("ssh免密登陆")]),s._v(" 服务器")]),s._v(" "),n("ul",[n("li",[s._v("after_success: # 在构建成功后要运行的命令，构建失败不会执行，其他同上")])])]),s._v(" "),n("li",[n("p",[s._v("自动在服务器上执行配置的脚本")])]),s._v(" "),n("li",[n("p",[s._v("完成自动部署")])])]),s._v(" "),n("h2",{attrs:{id:"_2-项目部署"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-项目部署"}},[s._v("#")]),s._v(" 2.项目部署")]),s._v(" "),n("blockquote",[n("ul",[n("li",[n("p",[s._v("Github公开项目(Travis对"),n("a",{attrs:{href:"https://travis-ci.org/",target:"_blank",rel:"noopener noreferrer"}},[s._v("开源项目"),n("OutboundLink")],1),s._v("是免费，对"),n("a",{attrs:{href:"https://travis-ci.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("私有项目"),n("OutboundLink")],1),s._v("是收费的)")]),s._v(" "),n("p",[s._v("所以使用travis需要在github创建公开项目")])])])]),s._v(" "),n("ol",[n("li",[n("h3",{attrs:{id:"创建github仓库-初始化工程"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建github仓库-初始化工程"}},[s._v("#")]),s._v(" 创建Github仓库，初始化工程")])]),s._v(" "),n("li",[n("h3",{attrs:{id:"在travis激活仓库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#在travis激活仓库"}},[s._v("#")]),s._v(" 在travis激活仓库")]),s._v(" "),n("p",[s._v("用Github账户登陆"),n("a",{attrs:{href:"https://travis-ci.org/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Travis-CI"),n("OutboundLink")],1),s._v("。Travis-CI会同步你的Github上面的所有仓库信息。")]),s._v(" "),n("p",[s._v("登陆之后会列出你的所有仓库:")])]),s._v(" "),n("li",[n("h3",{attrs:{id:"添加travis配置文件"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#添加travis配置文件"}},[s._v("#")]),s._v(" 添加Travis配置文件")]),s._v(" "),n("p",[s._v("在本地项目"),n("strong",[s._v("根目录")]),s._v("的"),n("strong",[s._v("master")]),s._v("分支里面添加 "),n("em",[n("strong",[s._v(".travis.yml")])]),s._v(" 配置文件")]),s._v(" "),n("p",[s._v("添加如下配置:")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("# .travis.yml\nlanguage: node_js   #前端工程所以是JavaScript，编译环境是node_js\nnode_js:\n- '8'   #指定node版本\nbranchs:\n  only:\n  - master  #指定只有检测到master分支有变动时才执行任务\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("将该配置文件推送到服务器。 返回Travis网站，此时Travis已经检测到该仓库的变动（有可能会有点延迟），所以会根据仓库根目录下的.travis.yml配置文件开始执行任务。")])])]),s._v(" "),n("p",[s._v("经过这三步，travis已经可以监控项目master分支的推送变动了。")]),s._v(" "),n("h2",{attrs:{id:"_3-travis配置使用ssh免密登陆服务器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-travis配置使用ssh免密登陆服务器"}},[s._v("#")]),s._v(" 3.Travis配置使用SSH免密登陆服务器")]),s._v(" "),n("blockquote",[n("p",[s._v("主要思路为：")]),s._v(" "),n("ol",[n("li",[s._v("在服务器上面生成公/私密钥对；")]),s._v(" "),n("li",[s._v("客户端发起连接请求时，服务器发送一个字符串给客户端，客户端用本地的私钥对字符串进行加密然后发送给服务器，服务器将收到的加密字符串用公钥解密，如果能解密成功就登陆成功。")]),s._v(" "),n("li",[s._v("把私钥放在Git代码仓库中，使用Travis提供了对私钥进行加密，把私钥加密之后放在代码仓库，在登陆的时候Travis解密该私钥用于连接。")])])]),s._v(" "),n("h3",{attrs:{id:"生成公钥-私钥对"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#生成公钥-私钥对"}},[s._v("#")]),s._v(" 生成公钥/私钥对")]),s._v(" "),n("h4",{attrs:{id:"在root用户下创建新用户travis"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#在root用户下创建新用户travis"}},[s._v("#")]),s._v(" 在"),n("strong",[s._v("root")]),s._v("用户下创建新用户travis")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#新建用户\nuseradd travis\n#修改密码（应该不是必要，但是万一以后需要用密码登陆呢）,按照提示设置密码。\npasswd travis\n#为用户添加添加权限\nvim /etc/sudoers\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("找到#Allow root to run any commands anywhere这一段注释，在下面新增一行：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("travis  ALL=(ALL)   ALL\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br")])]),n("h4",{attrs:{id:"生成密钥对"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#生成密钥对"}},[s._v("#")]),s._v(" 生成密钥对")]),s._v(" "),n("ul",[n("li",[s._v("一定要切到travis用户")]),s._v(" "),n("li",[s._v("passphase一定要为空")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#切换至用户travis，注意后面的操作都在该用户下操作，不然从git上面拉下来的代码或者生成的文件拥有着将不是travis，会造成一些麻烦\n[root@VM_156_69_centos ~]# su travis\n[travis@VM_156_69_centos root]$ cd ~\n# 生成RSA密钥对，后面所有的直接以默认就行，passphase一定要为空\n[travis@VM_156_69_centos ~]$ ssh-keygen -t rsa\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/home/travis/.ssh/id_rsa): \nCreated directory '/home/travis/.ssh'.\nEnter passphrase (empty for no passphrase): \nEnter same passphrase again: \nYour identification has been saved in /home/travis/.ssh/id_rsa.\nYour public key has been saved in /home/travis/.ssh/id_rsa.pub.\nThe key fingerprint is:\n8b:1f:5b:c5:b8:e2:09:21:0a:f8:6d:ef:5f:25:84:24 travis@VM_156_69_centos\nThe key's randomart image is:\n+--[ RSA 2048]----+\n|      E .        |\n|       o .       |\n|        . .      |\n|.        . o     |\n|o   . . S o +    |\n| o o . o . =     |\n|  o o o + +      |\n|   . . + B       |\n|     .o.*        |\n+-----------------+\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br")])]),n("p",[s._v("可以看到生成密钥对在用户家目录的.ssh文件夹("),n("strong",[s._v("/home/travis/.ssh")]),s._v(")下面。 由于Linux权限的控制规则，文件的权限不是越大越好，所有需要设置合适的权限。这里需要把**.ssh目录设置为700权限，给.sshm=目录下面的文件设置为600权限**")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#设置.ssh目录为700\n[travis@VM_156_69_centos ~]$ chmod 700 ~/.ssh/\n#设置.ssh目录下的文件为600\n[travis@VM_156_69_centos ~]$ chmod 600 ~/.ssh/*\n#可以看到下面的所有目录和文件所用者都是travis这个用户\n[travis@VM_156_69_centos ~]$ ls -al\ntotal 28\ndrwx------  3 travis travis 4096 Mar  6 20:12 .\ndrwxr-xr-x. 5 root   root   4096 Mar  6 20:03 ..\ndrwx------  2 travis travis 4096 Mar  6 20:12 .ssh\n[travis@VM_156_69_centos ~]$ ls ~/.ssh/ -al\ntotal 16\ndrwx------ 2 travis travis 4096 Mar  6 20:12 .\ndrwx------ 3 travis travis 4096 Mar  6 20:12 ..\n-rw------- 1 travis travis 1675 Mar  6 20:12 id_rsa\n-rw------- 1 travis travis  405 Mar  6 20:12 id_rsa.pub\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br")])]),n("h4",{attrs:{id:"将生成的公钥添加为受信列表-重点"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#将生成的公钥添加为受信列表-重点"}},[s._v("#")]),s._v(" "),n("em",[s._v("将生成的公钥添加为受信列表（重点）")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[travis@VM_156_69_centos ~]$ cd .ssh/\n#将公钥内容输出到authorized_keys中\n[travis@VM_156_69_centos .ssh]$ cat id_rsa.pub >> authorized_keys\n[travis@VM_156_69_centos .ssh]$ cat authorized_keys \n# authorized_keys文件内容类似这样\nssh-rsa  *************centos\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h4",{attrs:{id:"测试ssh登陆"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#测试ssh登陆"}},[s._v("#")]),s._v(" 测试SSH登陆")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#在.ssh目录下新增配置文件config\n[travis@VM_156_69_centos .ssh]$ vim config\n#添加下面代码段中的内容并保存\n#测试连接\n[travis@VM_156_69_centos .ssh]$ ssh test\nBad owner or permissions on /home/travis/.ssh/config\n#注意此时的测试是失败的，因为authorized_keys和config是我们后面添加的文件，文件权限并不是600\n[travis@VM_156_69_centos .ssh]$ ls -al\ntotal 28\ndrwx------ 2 travis travis 4096 Mar  6 20:40 .\ndrwx------ 3 travis travis 4096 Mar  6 20:38 ..\n-rw-rw-r-- 1 travis travis  405 Mar  6 20:40 authorized_keys\n-rw-rw-r-- 1 travis travis   91 Mar  6 20:38 config\n-rw------- 1 travis travis 1675 Mar  6 20:12 id_rsa\n-rw------- 1 travis travis  405 Mar  6 20:12 id_rsa.pub\n#修改文件权限\n[travis@VM_156_69_centos .ssh]$ chmod 600 config \n[travis@VM_156_69_centos .ssh]$ chmod 600 authorized_keys \n#查看修改后的权限\n[travis@VM_156_69_centos .ssh]$ ls -al\ntotal 28\ndrwx------ 2 travis travis 4096 Mar  6 20:40 .\ndrwx------ 3 travis travis 4096 Mar  6 20:38 ..\n-rw------- 1 travis travis  405 Mar  6 20:40 authorized_keys\n-rw------- 1 travis travis   91 Mar  6 20:38 config\n-rw------- 1 travis travis 1675 Mar  6 20:12 id_rsa\n-rw------- 1 travis travis  405 Mar  6 20:12 id_rsa.pub\n#重新执行测试\n[travis@VM_156_69_centos .ssh]$ ssh test \nThe authenticity of host '139.199.90.74 (139.199.90.74)' can't be established.\nECDSA key fingerprint is 41:39:50:e1:e7:c2:f5:19:86:dc:70:e5:91:42:bb:56.\nAre you sure you want to continue connecting (yes/no)? yes\nWarning: Permanently added '139.199.90.74' (ECDSA) to the list of known hosts.\nLast login: Tue Mar  6 20:43:32 2018 from 139.199.90.74\n#测试成功，生成了一个known_hosts文件，以后再登陆时就不需要在输入yes确认了，你可以再做一次测试\n[travis@VM_156_69_centos ~]$ ls .ssh/\nauthorized_keys  config  id_rsa  id_rsa.pub  known_hosts\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br")])]),n("p",[s._v("config文件内容：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("Host test\nHostName 99.99.99.99(你的服务器ip)\n#登陆的用户名\nUser travis\nIdentitiesOnly yes\n#登陆使用的密钥\nIdentityFile ~/.ssh/id_rsa\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("h2",{attrs:{id:"_4-安装travis客户端工具"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-安装travis客户端工具"}},[s._v("#")]),s._v(" 4.安装Travis客户端工具")]),s._v(" "),n("p",[s._v("Travis的客户端工具需要用gem来安装，"),n("strong",[s._v("gem")]),s._v("是ruby的管理工具，所以首先安装ruby。")]),s._v(" "),n("p",[s._v("这里直接采用ruby版本管理工具"),n("strong",[s._v("rvm")]),s._v("(类似nvm安装node)。")]),s._v(" "),n("h3",{attrs:{id:"安装rvm"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装rvm"}},[s._v("#")]),s._v(" 安装rvm")]),s._v(" "),n("p",[s._v("参考"),n("a",{attrs:{href:"http://www.rvm.io/",target:"_blank",rel:"noopener noreferrer"}},[s._v("www.rvm.io/"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[travis@VM_156_69_centos ~]# gpg2 --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3 7D2BAF1CF37B13E2069D6956105BD0E739499BDB\n[travis@VM_156_69_centos ~]# curl -sSL https://get.rvm.io | bash -s stable\n#安装完成后测试是否安装成功\n[root@VM_156_69_centos ~]# rvm version\nrvm 1.29.3 (master) by Michal Papis, Piotr Kuczynski, Wayne E. Seguin [https://rvm.io]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"安装ruby"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装ruby"}},[s._v("#")]),s._v(" 安装ruby")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[travis@VM_156_69_centos ~]# rvm list known\n// 查看所有ruby版本\n[travis@VM_156_69_centos ~]# rvm install 2.7\n#测试ruby安装\n[travis@VM_156_69_centos root]$ ruby --version\nruby 2.7.0p0 (2019-12-25 revision 647ee6f091) [x86_64-linux]\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"修改镜像源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#修改镜像源"}},[s._v("#")]),s._v(" 修改镜像源")]),s._v(" "),n("p",[s._v("安装完ruby之后就可以使用gem包管理工具了，但是好像官方镜像源被墙了，所以需要更换gem的镜像源。参考"),n("a",{attrs:{href:"https://gems.ruby-china.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("gems.ruby-china.com/"),n("OutboundLink")],1)]),s._v(" "),n("p",[s._v("注意这里是"),n("code",[s._v("gems.ruby-china.com")]),s._v("，而不是"),n("code",[s._v("org")]),s._v("域名。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("[travis@VM_156_69_centos ~]$ gem sources -l\n*** CURRENT SOURCES ***\n\nhttps://rubygems.org/\n[travis@VM_156_69_centos ~]$ gem -v\n2.6.14\n#更换镜像源\n[travis@VM_156_69_centos ~]$ gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/\nhttps://gems.ruby-china.com/ added to sources\nhttps://rubygems.org/ removed from sources\n[travis@VM_156_69_centos ~]$ gem sources -l\n*** CURRENT SOURCES ***\n\nhttps://gems.ruby-china.org/\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("h3",{attrs:{id:"安装travis命令行工具"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#安装travis命令行工具"}},[s._v("#")]),s._v(" 安装travis命令行工具")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#在travis下面提示没有权限，我切到root用户去安装\n[travis@VM_156_69_centos ~]$ gem install travis\nFetching: multipart-post-2.0.0.gem (100%)\nERROR:  While executing gem ... (Gem::FilePermissionError)\n    You dont have write permissions for the /usr/local/rvm/gems/ruby-2.4.1 directory.\n#安装travis\n[root@VM_156_69_centos ~]# gem install travis\nSuccessfully installed travis-1.8.8\nParsing documentation for travis-1.8.8\nDone installing documentation for travis after 1 seconds\n1 gem installed\n#切回travis用户，执行travis命令有以下输出说明安装成功\n[travis@VM_156_69_centos root]$ travis\nShell completion not installed. Would you like to install it now? |y| y\nUsage: travis COMMAND ...\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br")])]),n("h2",{attrs:{id:"_5-添加加密的私钥至代码仓库"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-添加加密的私钥至代码仓库"}},[s._v("#")]),s._v(" 5.添加加密的私钥至代码仓库")]),s._v(" "),n("p",[s._v("切换至travis用户，在家目录下拉取代码，进入代码目录。"),n("strong",[s._v("一定要切换至travis用户，要不然将没有权限操作这些文件，导致代码都不能提交")])]),s._v(" "),n("p",[s._v("执行下面命令生成加密的私钥文件")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("#首先用GitHub账户登陆travis\n[travis@VM_156_69_centos blog-front]$ travis login\nWe need your GitHub login to identify you.\nThis information will not be sent to Travis CI, only to api.github.com.\nThe password will not be displayed.\n\nTry running with --github-token or --auto if you dont want to enter your password anyway.\n\nUsername: lzq4047\nPassword for lzq4047: ******\nSuccessfully logged in as lzq4047!\n#登陆成功后解密私钥，--add参数会把加密的私钥解密命令插入到.travis.yml，Travis解密时要用到的\n[travis@VM_156_69_centos blog-front]$ travis encrypt-file ~/.ssh/id_rsa --add\nDetected repository as lzq4047/blog-front, is this correct? |yes| yes\nencrypting /home/travis/.ssh/id_rsa for lzq4047/blog-front\nstoring result as id_rsa.enc\n#由于我之前生成过，所有这里提示是否覆盖\nDANGER ZONE: Override existing id_rsa.enc? |no| yes\nstoring secure env variables for decryption\n\nMake sure to add id_rsa.enc to the git repository.\nMake sure not to add /home/travis/.ssh/id_rsa to the git repository.\nCommit all changes to your .travis.yml.\n#可以看到已经生成了加密后的私钥id_rsa.enc\n[travis@VM_156_69_centos blog-front]$ ls -al\ntotal 464\ndrwxrwxr-x 7 travis travis   4096 Mar  6 21:24 .\ndrwx------ 7 travis travis   4096 Mar  6 21:24 ..\n...\n-rw-rw-r-- 1 travis travis   1680 Mar  6 21:27 id_rsa.enc \n...\n-rw-rw-r-- 1 travis travis   1286 Mar  6 21:27 .travis.yml\n#.travis.yml中也自动添加了解密命令\n[travis@VM_156_69_centos blog-front]$ cat .travis.yml \nlanguage: node_js\nnode_js:\n- '8'\nbranchs:\n  only:\n  - master\nbefore_install:\n- openssl aes-256-cbc -K $encrypted_****_key -iv $encrypted_****_iv\n  -in id_rsa.enc -out ~/.ssh/id_rsa -d\n复制代码\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br")])]),n("p",[s._v("解释下解密命令中 "),n("em",[s._v("-in")]),s._v(" 和 "),n("em",[s._v("-out")]),s._v(" 参数:")]),s._v(" "),n("ul",[n("li",[s._v("-in 参数指定待解密的文件，位于仓库的根目录(Travis执行任务时会先把代码拉到Travis自己的服务器上，并进入仓库更目录)")]),s._v(" "),n("li",[s._v("-out 参数指定解密后的密钥存放在Travis服务器的~/.ssh/id_rsa，如果你的后面需要的话可以取这个路径，我看到网上有的SSH登陆方式用到了这个文件")])]),s._v(" "),n("h3",{attrs:{id:"这里有个大坑"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#这里有个大坑"}},[s._v("#")]),s._v(" 这里有个大坑")]),s._v(" "),n("p",[s._v("生成出来的钩子（下面这段）不能用！ travis自动编译时执行到这里会报错！")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("before_install:\n- openssl aes-256-cbc -K $encrypted_****_key -iv $encrypted_****_iv\n  -in id_rsa.enc -out ~\\/.ssh/id_rsa -d\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[s._v("为什么呢？！ 太坑了吧...")]),s._v(" "),n("p",[s._v("经过我半天的查找定位，最终在issues里找到了解决方案！")]),s._v(" "),n("p",[s._v("因为找不到存储在travis服务器的地址。。")]),s._v(" "),n("p",[s._v("所以要修改"),n("code",[s._v("-in id_rsa.enc -out ~\\/.ssh/id_rsa -d")])]),s._v(" "),n("p",[s._v("为"),n("code",[s._v("-in id_rsa.enc -out ~/.ssh/id_rsa -d")])]),s._v(" "),n("h3",{attrs:{id:"也就是删除-这个符号"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#也就是删除-这个符号"}},[s._v("#")]),s._v(" 也就是删除"),n("code",[s._v("\\")]),s._v("这个符号；")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("before_install:\n- openssl aes-256-cbc -K $encrypted_****_key -iv $encrypted_****_iv\n  -in id_rsa.enc -out ~/.ssh/id_rsa -d    // 这里删掉 ~\\/ 为~/\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("h2",{attrs:{id:"_6-配置after-success钩子"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-配置after-success钩子"}},[s._v("#")]),s._v(" 6.配置after_success钩子")]),s._v(" "),n("p",[s._v("前面的所有工作实际上都是为这一步做准备，SSH免密登陆服务器执行脚本。")]),s._v(" "),n("p",[s._v("在.travis.yml中添加一些配置，主要是after_success钩子配置。修改之后的配置如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("language: node_js\nnode_js:\n- '8'\nbranchs:\n  only:\n  - master\ninstall:\n- npm install\nscript:\n- npm run build\nenv:\n  global:\n    secure: *********\naddons:\n  ssh_known_hosts:\n  - 99.99.99.99 #受信主机，你的Linux服务器ip\nbefore_install:\n- openssl aes-256-cbc -K $encrypted_****_key -iv $encrypted_****_iv\n  -in id_rsa.enc -out ~/.ssh/id_rsa -d\nafter_success:\n- chmod 600 ~/.ssh/id_rsa   #还是Linux文件权限问题\n- ssh blog@139.199.90.74 -o StrictHostKeyChecking=no 'cd ~/blog-front && git pull && npm install && npm run build'   #使用ssh连接服务器\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br")])]),n("p",[n("strong",[s._v("注意：使用 ssh 命令连接一定要设置StrictHostKeyChecking=no，否则第一次连接时依然会要求你确认。后面引号的内容就是登陆你的Linux服务器之后，在你的服务器执行的命令，你也可以写成一个脚本。只要登陆上服务器之后，就随你操作了。")])]),s._v(" "),n("p",[s._v("after_success是在Travis执行完 "),n("strong",[s._v("install")]),s._v(" 和 "),n("strong",[s._v("script")]),s._v(" 之后执行的钩子,其他的Travis配置可以参考官方文档。我这里构建成功之后就简单的build一下，看能不能build成功，build成功才登陆服务器，在服务器上build（当然也可以直接把Travis的build结果通过scp拷贝到服务器指定目录）...")])])}),[],!1,null,null,null);a.default=t.exports}}]);