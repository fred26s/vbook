<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>服务端鉴权jwt | BLOG</title>
    <meta name="generator" content="VuePress 1.5.4">
    <link rel="icon" href="/vbook/favicon.ico">
    <meta name="description" content="学习笔记">
    <link rel="preload" href="/vbook/assets/css/0.styles.e0606203.css" as="style"><link rel="preload" href="/vbook/assets/js/app.56a9a2ed.js" as="script"><link rel="preload" href="/vbook/assets/js/2.2ce5df5b.js" as="script"><link rel="preload" href="/vbook/assets/js/25.0f12410b.js" as="script"><link rel="prefetch" href="/vbook/assets/js/10.09b2ea05.js"><link rel="prefetch" href="/vbook/assets/js/11.b33443e5.js"><link rel="prefetch" href="/vbook/assets/js/12.31280131.js"><link rel="prefetch" href="/vbook/assets/js/13.1ae03640.js"><link rel="prefetch" href="/vbook/assets/js/14.d41b2257.js"><link rel="prefetch" href="/vbook/assets/js/15.b571d130.js"><link rel="prefetch" href="/vbook/assets/js/16.8a84fe06.js"><link rel="prefetch" href="/vbook/assets/js/17.be4efc3d.js"><link rel="prefetch" href="/vbook/assets/js/18.d449664b.js"><link rel="prefetch" href="/vbook/assets/js/19.8f8c2dff.js"><link rel="prefetch" href="/vbook/assets/js/20.5d3267da.js"><link rel="prefetch" href="/vbook/assets/js/21.a6523cdd.js"><link rel="prefetch" href="/vbook/assets/js/22.c640d9af.js"><link rel="prefetch" href="/vbook/assets/js/23.879bf70a.js"><link rel="prefetch" href="/vbook/assets/js/24.bd48ace9.js"><link rel="prefetch" href="/vbook/assets/js/26.718ccfa4.js"><link rel="prefetch" href="/vbook/assets/js/27.f153037d.js"><link rel="prefetch" href="/vbook/assets/js/28.508d01f9.js"><link rel="prefetch" href="/vbook/assets/js/29.dbe0222b.js"><link rel="prefetch" href="/vbook/assets/js/3.dfccb20d.js"><link rel="prefetch" href="/vbook/assets/js/30.9988d278.js"><link rel="prefetch" href="/vbook/assets/js/31.6008081f.js"><link rel="prefetch" href="/vbook/assets/js/32.6d16c0dd.js"><link rel="prefetch" href="/vbook/assets/js/33.e4e21daf.js"><link rel="prefetch" href="/vbook/assets/js/34.d37fab85.js"><link rel="prefetch" href="/vbook/assets/js/35.6f741ed5.js"><link rel="prefetch" href="/vbook/assets/js/36.58d8b589.js"><link rel="prefetch" href="/vbook/assets/js/37.674e27ab.js"><link rel="prefetch" href="/vbook/assets/js/38.fa018258.js"><link rel="prefetch" href="/vbook/assets/js/39.2f197b8d.js"><link rel="prefetch" href="/vbook/assets/js/4.d599a372.js"><link rel="prefetch" href="/vbook/assets/js/40.60890a66.js"><link rel="prefetch" href="/vbook/assets/js/41.99ac89f4.js"><link rel="prefetch" href="/vbook/assets/js/42.fc4ec52c.js"><link rel="prefetch" href="/vbook/assets/js/43.f3404978.js"><link rel="prefetch" href="/vbook/assets/js/44.98c5c2de.js"><link rel="prefetch" href="/vbook/assets/js/45.4f1b0703.js"><link rel="prefetch" href="/vbook/assets/js/46.ed7569c8.js"><link rel="prefetch" href="/vbook/assets/js/5.4413bd57.js"><link rel="prefetch" href="/vbook/assets/js/6.0afd5f60.js"><link rel="prefetch" href="/vbook/assets/js/7.61ee7893.js"><link rel="prefetch" href="/vbook/assets/js/8.aa2210e7.js"><link rel="prefetch" href="/vbook/assets/js/9.2be3499c.js">
    <link rel="stylesheet" href="/vbook/assets/css/0.styles.e0606203.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vbook/" class="home-link router-link-active"><!----> <span class="site-name">BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习笔记" class="dropdown-title"><span class="title">前端学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端学习笔记" class="mobile-dropdown-title"><span class="title">前端学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/front-end/evo/优化方式.html" class="nav-link">
  前端优化
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/js/es6知识.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/vue/vue知识点.html" class="nav-link">
  VUE
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/webpack/webpack基础.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/net/网络基础.html" class="nav-link">
  网络基础
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/tools/GIT.html" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/ci/travis自动部署.html" class="nav-link">
  前端自动化
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后台学习笔记" class="dropdown-title"><span class="title">后台学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="后台学习笔记" class="mobile-dropdown-title"><span class="title">后台学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/back-end/node/express.html" class="nav-link">
  NodeJS
</a></li><li class="dropdown-item"><!----> <a href="/vbook/back-end/lib-web/RESTful.html" class="nav-link">
  web开发知识
</a></li><li class="dropdown-item"><!----> <a href="/vbook/back-end/server/Nginx.html" class="nav-link">
  服务器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JustDoIT" class="dropdown-title"><span class="title">JustDoIT</span> <span class="arrow down"></span></button> <button type="button" aria-label="JustDoIT" class="mobile-dropdown-title"><span class="title">JustDoIT</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/funs/hardware/arduino.html" class="nav-link">
  硬件
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习笔记" class="dropdown-title"><span class="title">前端学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端学习笔记" class="mobile-dropdown-title"><span class="title">前端学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/front-end/evo/优化方式.html" class="nav-link">
  前端优化
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/js/es6知识.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/vue/vue知识点.html" class="nav-link">
  VUE
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/webpack/webpack基础.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/net/网络基础.html" class="nav-link">
  网络基础
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/tools/GIT.html" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/ci/travis自动部署.html" class="nav-link">
  前端自动化
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后台学习笔记" class="dropdown-title"><span class="title">后台学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="后台学习笔记" class="mobile-dropdown-title"><span class="title">后台学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/back-end/node/express.html" class="nav-link">
  NodeJS
</a></li><li class="dropdown-item"><!----> <a href="/vbook/back-end/lib-web/RESTful.html" class="nav-link">
  web开发知识
</a></li><li class="dropdown-item"><!----> <a href="/vbook/back-end/server/Nginx.html" class="nav-link">
  服务器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JustDoIT" class="dropdown-title"><span class="title">JustDoIT</span> <span class="arrow down"></span></button> <button type="button" aria-label="JustDoIT" class="mobile-dropdown-title"><span class="title">JustDoIT</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/funs/hardware/arduino.html" class="nav-link">
  硬件
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>NodeJS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vbook/back-end/node/express.html" class="sidebar-link">express</a></li><li><a href="/vbook/back-end/node/服务端鉴权.html" class="active sidebar-link">服务端鉴权</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vbook/back-end/node/服务端鉴权.html#服务端鉴权jwt" class="sidebar-link">服务端鉴权jwt</a></li><li class="sidebar-sub-header"><a href="/vbook/back-end/node/服务端鉴权.html#session-cookie" class="sidebar-link">session-cookie</a></li><li class="sidebar-sub-header"><a href="/vbook/back-end/node/服务端鉴权.html#json-web-token" class="sidebar-link">json-web-token</a></li><li class="sidebar-sub-header"><a href="/vbook/back-end/node/服务端鉴权.html#session和jwt的区别" class="sidebar-link">session和jwt的区别</a></li><li class="sidebar-sub-header"><a href="/vbook/back-end/node/服务端鉴权.html#jwt加强版" class="sidebar-link">jwt加强版</a></li></ul></li><li><a href="/vbook/back-end/node/node后台-ts实现.html" class="sidebar-link">node后台搭建-TS篇</a></li><li><a href="/vbook/back-end/node/node后台-工具相关.html" class="sidebar-link">node后台搭建-工具环境篇</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="服务端鉴权jwt"><a href="#服务端鉴权jwt" class="header-anchor">#</a> 服务端鉴权jwt</h2> <p>今天项目写到了express后台鉴权部分，记录一下关于服务端鉴权的知识；</p> <p>常用鉴权方式可大致分为<strong>有状态</strong>和<strong>无状态</strong>两种；</p> <ul><li><h3 id="有状态"><a href="#有状态" class="header-anchor">#</a> 有状态</h3> <p>常用代表：session-cookie会话方案</p></li> <li><h3 id="无状态"><a href="#无状态" class="header-anchor">#</a> 无状态</h3> <p>常用代表：json-web-token令牌方案</p></li></ul> <h2 id="session-cookie"><a href="#session-cookie" class="header-anchor">#</a> session-cookie</h2> <p>传统方案客户端鉴权我们使用的都是<code>session-cookie</code>，即由于HTTP请求是无状态的，我们需要判断每个请求到底对应的是哪些用户发送的，所以通过cookie存储服务端的sesssionID来鉴权；</p> <p>正是因为要靠服务端来查询用户的信息，所以决定了要实现跨服务器比较困难，这是基于cookie/session应用天生的短板。</p> <h3 id="如何实现"><a href="#如何实现" class="header-anchor">#</a> 如何实现</h3> <ol><li><p>所以我们在每个用户成功登陆后，给他创建并响应颁发一个随机生成的ID，叫做<code>sessionID</code>；</p> <p>然后将sessionID和用户信息，作为key-value的形式存储在数据库中（也可能存在缓存，总是需要保存下来）；</p></li> <li><p>当客户端之后再次请求时，需要在<code>cookie</code>带上登录时服务器颁发的<code>sessionID</code>;</p></li> <li><p>服务端接受请求后，将<code>cookie</code>中的<code>sessionID</code>拿出来<strong>进行查询</strong>，判断是否有效ID，得到当前请求用户的信息；</p></li></ol> <h2 id="json-web-token"><a href="#json-web-token" class="header-anchor">#</a> json-web-token</h2> <p>token其实也是为了服务器鉴权而生，和<code>session</code>的实现原理也相似；</p> <p>他们的区别在于，使用token时服务端不需要存储用户的信息，</p> <p>而是在用户登录时，直接将用户ID相关的信息直接通过加密算法生成一个<strong>令牌token</strong>，直接发送给客户端保存；</p> <p>这样服务端只需要解码校验token即可，校验通过即证明用户合法，实现了服务端无状态；</p> <p>服务端无需管理用户信息的存储，就可以知道当前请求是哪个用户发来的（token包含了用户信息）；</p> <h3 id="如何实现-2"><a href="#如何实现-2" class="header-anchor">#</a> 如何实现</h3> <ol><li><p>用户成功登陆后，服务端签发一个经过加密算法，且包含用户信息的token，返回给客户端；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>express中我们可以使用[jsonwebtoken]这个中间件；
方便我们进行加密算法及相关过期时间的设置
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li> <li><p>下次用户请求时，需要在请求头带上token；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>例如，express-jwt在验证TOKEN时，是验证请求头中的`authorization`;
并且，有专门的标识格式，token前添加Bearer，所以在请求头中就需要带上：

authorization：Bearer token....
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li> <li><p>客户端接收请求时，实时解码token进行校验，即可判断用户权限；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>这里我们使用[express-jwt]这个中间件，来验证客户端token；
express-jwt实际内部是对jsonwebtoken做了引用二次封装，

-jsonwebtoken负责加密生成token
-express-jwt负责解密验证token
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol> <h2 id="session和jwt的区别"><a href="#session和jwt的区别" class="header-anchor">#</a> session和jwt的区别</h2> <p>看到一个很形象的例子，可以看出两者的区别：</p> <p>都是去某个办公室办业务，两种方式的区别就像：</p> <ul><li><p>session：</p> <p>我发给你一张身份证，但只是一张写着身份证号码的纸片。</p> <p>你每次来办事，我需要去后台查一下你纸片上的 id 是不是有效。</p></li> <li><p>jwt:</p> <p>我发给你一张加密的身份证，以后你只要出示这张卡片，我就知道你一定是自己人。</p></li></ul> <h2 id="jwt加强版"><a href="#jwt加强版" class="header-anchor">#</a> jwt加强版</h2> <p>实际场景中，如果担心token被盗用问题或优化用户体验，并仍保持jwt的无状态性，可以使用<code>refresh_token</code>;</p> <p>因为token有效时间过短，可能造成了用户需要频繁登录，体验会很差，若有效期过长又有安全风险，</p> <p>所以衍生出了双token认证方式；</p> <h3 id="refresh-token-token"><a href="#refresh-token-token" class="header-anchor">#</a> refresh_token &amp; token</h3> <p>相当于用户登录时，返回两个token，分别是</p> <ul><li><p>refresh_token 刷新token</p> <p>用来刷新access_token，有效期时间较长；</p></li> <li><p>access_token 访问token</p> <p>为安全起见，有效期设置较短（1h内）</p></li></ul> <h3 id="使用方式"><a href="#使用方式" class="header-anchor">#</a> 使用方式</h3> <ol><li><p>用户登录后，返回两个token</p> <p>在访问资源接口时，和常规一样带上<code>access_token</code>作为请求头；</p></li> <li><p>当服务端校验access_token失效时（过期），客户端不直接跳出页面到登录页；</p> <p>而是直接使用<code>refresh_token</code>，请求接口刷新过期的<code>access_token</code>；</p> <p>客户端使用新的<code>access_token</code>再次访问资源接口；</p></li> <li><p>当<code>refresh_token</code>也到期后，刷新token无效，再将用户弹出至登录页；</p></li></ol> <p>个人理解，这样除了可以避免用户频繁登录，让用户无感刷新<code>access_token</code>，</p> <p>并且也可以尽量减少<code>access_token</code>被盗用的风险（因为有效期较短）；</p> <p>而<code>refresh_token</code>虽然有效期长，但通讯次数少（只有当access过期时，才使用），风险也相应降低；</p> <p>毕竟没有完美的安全认证系统，只要能尽量减少被攻击机会，制造被攻击难度，即是我们所认为的安全认证；</p> <h3 id="其他方式"><a href="#其他方式" class="header-anchor">#</a> 其他方式</h3> <p>包括在服务端存储<code>jwt</code>白名单或黑名单，即通过<code>jwt</code>解码认证后，再服务端进行token是否有效的查询；</p> <p>个人认为这种实现方式和传统的<code>session</code>认证区别不大，背离了jwt无状态的优势和原则，所以不详细记录了；</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vbook/back-end/node/express.html" class="prev">
        express
      </a></span> <span class="next"><a href="/vbook/back-end/node/node后台-ts实现.html">
        node后台搭建-TS篇
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vbook/assets/js/app.56a9a2ed.js" defer></script><script src="/vbook/assets/js/2.2ce5df5b.js" defer></script><script src="/vbook/assets/js/25.0f12410b.js" defer></script>
  </body>
</html>
