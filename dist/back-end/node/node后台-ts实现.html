<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TS 中使用 nodejs 搭建后端服务 | BLOG</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/vbook/favicon.ico">
    <meta name="description" content="学习笔记">
    
    <link rel="preload" href="/vbook/assets/css/0.styles.5726f3cc.css" as="style"><link rel="preload" href="/vbook/assets/js/app.64803a45.js" as="script"><link rel="preload" href="/vbook/assets/js/2.dceffa7a.js" as="script"><link rel="preload" href="/vbook/assets/js/25.ee58070b.js" as="script"><link rel="prefetch" href="/vbook/assets/js/10.c8b41500.js"><link rel="prefetch" href="/vbook/assets/js/11.28c79869.js"><link rel="prefetch" href="/vbook/assets/js/12.602d258e.js"><link rel="prefetch" href="/vbook/assets/js/13.5225f803.js"><link rel="prefetch" href="/vbook/assets/js/14.86b3e846.js"><link rel="prefetch" href="/vbook/assets/js/15.020c6177.js"><link rel="prefetch" href="/vbook/assets/js/16.a5de8ab6.js"><link rel="prefetch" href="/vbook/assets/js/17.d4b4394b.js"><link rel="prefetch" href="/vbook/assets/js/18.5ac69d76.js"><link rel="prefetch" href="/vbook/assets/js/19.3ebe5320.js"><link rel="prefetch" href="/vbook/assets/js/20.ba80d828.js"><link rel="prefetch" href="/vbook/assets/js/21.993ca315.js"><link rel="prefetch" href="/vbook/assets/js/22.79c4804a.js"><link rel="prefetch" href="/vbook/assets/js/23.71cd2d95.js"><link rel="prefetch" href="/vbook/assets/js/24.1713254d.js"><link rel="prefetch" href="/vbook/assets/js/26.7d9e9d4c.js"><link rel="prefetch" href="/vbook/assets/js/27.77f61c94.js"><link rel="prefetch" href="/vbook/assets/js/28.04024ee9.js"><link rel="prefetch" href="/vbook/assets/js/29.5bcff1cd.js"><link rel="prefetch" href="/vbook/assets/js/3.3423f2fc.js"><link rel="prefetch" href="/vbook/assets/js/30.d1ca5e75.js"><link rel="prefetch" href="/vbook/assets/js/31.64668596.js"><link rel="prefetch" href="/vbook/assets/js/32.0b2d1e6f.js"><link rel="prefetch" href="/vbook/assets/js/33.5a061f89.js"><link rel="prefetch" href="/vbook/assets/js/34.2e3c7ab2.js"><link rel="prefetch" href="/vbook/assets/js/35.7218c247.js"><link rel="prefetch" href="/vbook/assets/js/36.60fc61bd.js"><link rel="prefetch" href="/vbook/assets/js/37.a14c1b7b.js"><link rel="prefetch" href="/vbook/assets/js/38.df2691ed.js"><link rel="prefetch" href="/vbook/assets/js/39.463ecbf5.js"><link rel="prefetch" href="/vbook/assets/js/4.d9efc253.js"><link rel="prefetch" href="/vbook/assets/js/40.f16d5670.js"><link rel="prefetch" href="/vbook/assets/js/41.65ce97f3.js"><link rel="prefetch" href="/vbook/assets/js/42.ccd3754e.js"><link rel="prefetch" href="/vbook/assets/js/43.fdc58166.js"><link rel="prefetch" href="/vbook/assets/js/44.aa0425dc.js"><link rel="prefetch" href="/vbook/assets/js/45.28e1b46e.js"><link rel="prefetch" href="/vbook/assets/js/46.9f678d14.js"><link rel="prefetch" href="/vbook/assets/js/47.5f63502f.js"><link rel="prefetch" href="/vbook/assets/js/48.07651b39.js"><link rel="prefetch" href="/vbook/assets/js/5.6b3bdc86.js"><link rel="prefetch" href="/vbook/assets/js/6.c9f44ce5.js"><link rel="prefetch" href="/vbook/assets/js/7.c95ece88.js"><link rel="prefetch" href="/vbook/assets/js/8.e5718fb1.js"><link rel="prefetch" href="/vbook/assets/js/9.ba545b0a.js">
    <link rel="stylesheet" href="/vbook/assets/css/0.styles.5726f3cc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vbook/" class="home-link router-link-active"><!----> <span class="site-name">BLOG</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习笔记" class="dropdown-title"><span class="title">前端学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端学习笔记" class="mobile-dropdown-title"><span class="title">前端学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/front-end/evo/优化方式.html" class="nav-link">
  前端优化
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/js/es6知识.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/vue/vue知识点.html" class="nav-link">
  VUE
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/webpack/webpack基础.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/net/网络基础.html" class="nav-link">
  网络基础
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/tools/GIT.html" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/ci/travis自动部署.html" class="nav-link">
  前端自动化
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后台学习笔记" class="dropdown-title"><span class="title">后台学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="后台学习笔记" class="mobile-dropdown-title"><span class="title">后台学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/back-end/node/express.html" class="nav-link">
  NodeJS
</a></li><li class="dropdown-item"><!----> <a href="/vbook/back-end/lib-web/RESTful.html" class="nav-link">
  web开发知识
</a></li><li class="dropdown-item"><!----> <a href="/vbook/back-end/server/Nginx.html" class="nav-link">
  服务器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JustDoIT" class="dropdown-title"><span class="title">JustDoIT</span> <span class="arrow down"></span></button> <button type="button" aria-label="JustDoIT" class="mobile-dropdown-title"><span class="title">JustDoIT</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/funs/hardware/arduino.html" class="nav-link">
  硬件
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习笔记" class="dropdown-title"><span class="title">前端学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端学习笔记" class="mobile-dropdown-title"><span class="title">前端学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/front-end/evo/优化方式.html" class="nav-link">
  前端优化
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/js/es6知识.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/vue/vue知识点.html" class="nav-link">
  VUE
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/webpack/webpack基础.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/net/网络基础.html" class="nav-link">
  网络基础
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/tools/GIT.html" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/vbook/front-end/ci/travis自动部署.html" class="nav-link">
  前端自动化
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后台学习笔记" class="dropdown-title"><span class="title">后台学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="后台学习笔记" class="mobile-dropdown-title"><span class="title">后台学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/back-end/node/express.html" class="nav-link">
  NodeJS
</a></li><li class="dropdown-item"><!----> <a href="/vbook/back-end/lib-web/RESTful.html" class="nav-link">
  web开发知识
</a></li><li class="dropdown-item"><!----> <a href="/vbook/back-end/server/Nginx.html" class="nav-link">
  服务器
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JustDoIT" class="dropdown-title"><span class="title">JustDoIT</span> <span class="arrow down"></span></button> <button type="button" aria-label="JustDoIT" class="mobile-dropdown-title"><span class="title">JustDoIT</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vbook/funs/hardware/arduino.html" class="nav-link">
  硬件
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>NodeJS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vbook/back-end/node/express.html" class="sidebar-link">express</a></li><li><a href="/vbook/back-end/node/服务端鉴权.html" class="sidebar-link">服务端鉴权</a></li><li><a href="/vbook/back-end/node/node后台-ts实现.html" class="active sidebar-link">node后台搭建-TS篇</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/vbook/back-end/node/node后台-ts实现.html#ts-中使用-nodejs-搭建后端服务" class="sidebar-link">TS 中使用 nodejs 搭建后端服务</a></li><li class="sidebar-sub-header"><a href="/vbook/back-end/node/node后台-ts实现.html#安装环境" class="sidebar-link">安装环境</a></li><li class="sidebar-sub-header"><a href="/vbook/back-end/node/node后台-ts实现.html#修改目录结构" class="sidebar-link">修改目录结构</a></li><li class="sidebar-sub-header"><a href="/vbook/back-end/node/node后台-ts实现.html#启动服务" class="sidebar-link">启动服务</a></li><li class="sidebar-sub-header"><a href="/vbook/back-end/node/node后台-ts实现.html#安装-mysql-库" class="sidebar-link">安装 mysql 库</a></li><li class="sidebar-sub-header"><a href="/vbook/back-end/node/node后台-ts实现.html#新增-mysql-配置文件" class="sidebar-link">新增 Mysql 配置文件</a></li><li class="sidebar-sub-header"><a href="/vbook/back-end/node/node后台-ts实现.html#划分mvc架构" class="sidebar-link">划分MVC架构</a></li></ul></li><li><a href="/vbook/back-end/node/node后台-工具相关.html" class="sidebar-link">node后台搭建-工具环境篇</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="ts-中使用-nodejs-搭建后端服务"><a href="#ts-中使用-nodejs-搭建后端服务" class="header-anchor">#</a> TS 中使用 nodejs 搭建后端服务</h2> <p>这里记录下自己使用TypeScript + nodeJS技术栈搭建一套后台服务的流程；</p> <h2 id="安装环境"><a href="#安装环境" class="header-anchor">#</a> 安装环境</h2> <h3 id="express-generator"><a href="#express-generator" class="header-anchor">#</a> express-generator</h3> <p>全局安装后，就可以直接使用<code>express</code>命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm i express-generator -g
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="初始化项目结构"><a href="#初始化项目结构" class="header-anchor">#</a> 初始化项目结构</h3> <p>使用<code>express</code>命令创建项目结构</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>express --view=jade XXXX
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>生成的项目包含这些内容：</p> <ul><li>bin</li> <li>public</li> <li>routes</li> <li>views</li> <li>-app.js</li> <li>-package.json</li></ul> <h3 id="新增项目结构"><a href="#新增项目结构" class="header-anchor">#</a> 新增项目结构</h3> <p>新增一些项目必须的文件夹结构；</p> <ul><li>config 存放配置文件</li> <li>controller 接口逻辑</li> <li>model 数据库相关</li> <li>types 第三方库声明文件</li> <li>utils 工具函数</li></ul> <h3 id="安装依赖"><a href="#安装依赖" class="header-anchor">#</a> 安装依赖</h3> <p>先安装初始化项目<code>package.json</code>中默认依赖的包；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm i
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装<code>typescript</code>；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm i typescript -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>因为在<code>ts</code>中开发 node，所以安装<code>node</code>以及<code>express</code>框架的声明文件；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm i @types/express @types/node -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="修改目录结构"><a href="#修改目录结构" class="header-anchor">#</a> 修改目录结构</h2> <h3 id="修改所有-js-文件为-ts"><a href="#修改所有-js-文件为-ts" class="header-anchor">#</a> 修改所有.js 文件为.ts</h3> <p>因为我们要使用 ts 来写 node 项目，所以先将初始化项目中所有<code>.js</code>文件修改为<code>.ts</code>；</p> <p>具体有：</p> <ul><li>bin 中的<code>www</code> ，挪至根目录，修改为<code>server.ts</code></li> <li>根目录的<code>app.js</code>，修改为<code>app.ts</code></li> <li><code>routes</code>路由目录下，修改路由文件为<code>.ts</code></li></ul> <p>修改完成后项目结构为：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>- public
- routes
- types
- views
- -app.ts
- -package.json
- -server.ts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="配置-tsconfig-json"><a href="#配置-tsconfig-json" class="header-anchor">#</a> 配置 tsconfig.json</h3> <ul><li><p>outDir</p> <p>修改输出目录为<code>./dist</code>文件夹</p></li> <li><p>moduleResolution</p> <p>选择模块解析策略，为<code>node</code>；</p></li> <li><p>baseUrl</p> <p>基础为<code>.</code></p></li> <li><p>path</p> <p><code>&quot;*&quot;: [&quot;node_modules/*&quot;, &quot;./types/*&quot;]</code></p></li></ul> <h3 id="配置-package-json"><a href="#配置-package-json" class="header-anchor">#</a> 配置 package.json</h3> <p>先配置脚本文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>&quot;scripts&quot;: {
    &quot;start&quot;: &quot;npm run serve&quot;,
    // 启动服务
    &quot;serve&quot;: &quot;node ./dist/server.js&quot;,
    // 打包
    &quot;build&quot;: &quot;tsc &amp;&amp; node ./handle-public.js&quot;,
    // cross-env NODE_ENV=develop 表示当环境变量是develop时
    // nodemon 相当于Node中的热更新插件 -e 表示指定检测的文件类型为ts, tsx
    // --exec 表示nodemon将监视和执行的文件 后面跟着 ./server.ts
    // ts-node 是因为nodemon只能执行js文件，所以使用这个插件，可以在node环境执行ts文件
    &quot;dev&quot;: &quot;cross-env NODE_ENV=develop nodemon -e ts, tsx --exec 'ts-node' ./server.ts&quot;
},
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h2 id="启动服务"><a href="#启动服务" class="header-anchor">#</a> 启动服务</h2> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm run dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>okay，现在已经成功启动<code>express</code>服务了。</p> <h2 id="安装-mysql-库"><a href="#安装-mysql-库" class="header-anchor">#</a> 安装 mysql 库</h2> <p>npm 安装 mysql 模块和声明文件，用来连接操作数据库</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm i mysql -S
npm i @types/mysql -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="新增-mysql-配置文件"><a href="#新增-mysql-配置文件" class="header-anchor">#</a> 新增 Mysql 配置文件</h2> <p>在根目录新增<code>config</code>文件夹，存放项目配置文件，并新增子文件<code>mysql.config.ts</code>来管理数据库配置；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>const devConfig = {
  host: 'localhost',
  database: 'ts',
  user: 'root',
  password: '666666'
}

const prodConfig = {
  host: '192.168.0.1',
  database: 'ts',
  port: 3306
}

module.exports = process.env.NODE_ENV === 'development' ? devConfig : prodConfig

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="划分mvc架构"><a href="#划分mvc架构" class="header-anchor">#</a> 划分MVC架构</h2> <h3 id="model-层"><a href="#model-层" class="header-anchor">#</a> model 层</h3> <p>在根目录新增<code>model</code>文件夹，存放数据层文件；</p> <ul><li><p>新增子文件<code>index.ts</code>来连接数据库，并导出 sql 实例；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>import mysql = require('mysql')
const mysqlConfig = require('../config/mysql.config')

const sql = mysql.createConnection(mysqlConfig)
sql.connect()

export = sql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>新增文件夹<code>tables</code>，来管理表，具体的表 sql 语句都放在这个文件夹内</p> <p>-model</p> <p>-tables</p></li></ul> <h3 id="业务-sql"><a href="#业务-sql" class="header-anchor">#</a> 业务 sql</h3> <p>我们现在创建一个<code>image</code>表，就在<code>tables</code>目录下新建<code>image.ts</code>，来存放 sql；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>module.exports = sql =&gt; {
  sql.query(
    'SELECT table_name FROM information_schema.TABLES WHERE table_name =&quot;image&quot;',
    (err, res) =&gt; {
      if (res &amp;&amp; res.length) return                  // 如果没有此表，就创建
      sql.query(`CREATE TABLE \`image\` (
            \`id\` INT NOT NULL AUTO_INCREMENT,
            \`file_key\` VARCHAR(45) NOT NULL,
            \`file_name\` VARCHAR(45) NOT NULL,
            PRIMARY KEY (\`id\`))`)
    }
  )
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><code>image.ts</code>暴露出的是一个函数，内部包含具体的 sql 逻辑语句；</p> <p>将此 sql 引入<code>tables-index.ts</code> 文件，绑定在 sql 实例上；</p> <p>这样就可以将所有具体的业务 sql 文件都引入到这个<code>index.ts</code>中，最终暴露给<code>server.ts</code>这一个文件即可；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>----------tables内 index.ts----------------
import mysql = require('mysql')
const mysqlConfig = require('../config/mysql.config')

const sql = mysql.createConnection(mysqlConfig)
sql.connect()                                    // 连接数据库
require('./tables/image')(sql)                  // 用实例执行具体业务sql语句

export = sql
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>将<code>model</code>层<code>index.ts</code>，暴露给<code>server.ts</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>var app = require('./app')
var debug = require('debug')('service:server')
var http = require('http')
require('./model')                  // 暴露index.ts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="views-层"><a href="#views-层" class="header-anchor">#</a> views 层</h3> <p>在<code>app.ts</code>中，可以指定视图页面文件夹；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>app.set('views', path.join(__dirname, 'views'));   // 默认使用根目录`views`文件夹
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>所以我们在根目录的<code>views</code>文件夹就可以新建一个视图页面，这里我们使用的是<code>jade</code>模板；</p> <p>-views</p> <p>-upload.jade</p> <p>在新建的模板中使用<code>jade</code>语法创建 HTML；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>extends layout

block content
  h1 this is fred's world! :)
  h1 And The Awesome Day.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>然后我们在路由文件中，配置对应的路由地址即可显示刚才创建的模板页面；</p> <p>打开<code>routes - index.ts</code>，添加对应的路由：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>router.get('/upload', function(req, res, next) {
  res.render('upload', { title: 'Express' })             // 第一个参数表示路由地址
})
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这里<code>render</code>函数有两个参数：</p> <ol><li><p>第一个参数表示路由地址，即你在浏览器 url 中输入的地址路径；</p></li> <li><p>第二个参数是传入该路由的参数；</p> <p>这个例子中，是在页面 HEAD 中使用了 title；</p></li></ol> <p>然后配置好页面和路由后，我们就可以访问<code>&lt;http://localhost:3000/upload&gt;</code>（默认端口 3000），跳转到刚才创建的页面了。</p> <h3 id="controller-层"><a href="#controller-层" class="header-anchor">#</a> controller 层</h3> <p>现在我们准备写一个组件上传文件的案例，内容是：</p> <ol><li>页面使用<code>input</code>上传文件；</li> <li>我们后台接受文件存储到指定文件夹；</li> <li>将文件索引存储数据库；</li></ol> <p>所以第一步在后台定义<code>api</code>接口：</p> <h3 id="封装文件上传方法"><a href="#封装文件上传方法" class="header-anchor">#</a> 封装文件上传方法</h3> <p>我们把具体的处理文件上传的方法封装在根目录下的<code>utils/uploadFiles.ts</code>内；</p> <p>-utils</p> <p>-uploadFiles.ts</p> <p><strong>先安装依赖库 formidable</strong></p> <blockquote><p>这个依赖库模块可以实现上传和编码图片和视频。它支持 GB 级上传数据处理，支持多种客户端数据提交。</p></blockquote> <p>因为要接受表单形式上传的文件，并进行处理，所以需要下载依赖库；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>npm i formidable -S
npm i @types/formidable -D
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后封装使用依赖库处理文件的方法，我们把这个具体处理文件的方法封装在工具函数<code>utils</code>文件夹中：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-----------------utils / uploadFiles.ts-------------------------

import path = require('path')
import formidable = require('formidable')

export = req =&gt; {
  return new Promise((resolve, reject) =&gt; {
    const form = new formidable.IncomingForm()
    form.encoding = 'utf-8'                                     // 文件编码
    form.uploadDir = path.join(__dirname, '../files/')         // 上传的文件保存位置[暂定项目根目录]
    form.keepExtensions = true                                 // 保留文件后缀
    form.parse(req, (err, fields, files) =&gt; {
      const { file } = files                              // 文件对象
      if (!err) resolve(file)
      else reject(err)
    })
  })
}

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="创建-controller"><a href="#创建-controller" class="header-anchor">#</a> 创建 controller</h3> <p>我们具体的逻辑写在<code>controller</code>中，所以根目录新建<code>controller</code>文件夹，然后创建<code>api.ts</code>文件用来写具体逻辑：</p> <p>-controller</p> <p>-api.ts</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>---------------------controller / api.ts------------------------
const uploadFiles = require('../utils/uploadFiles')              // 引入工具函数 处理上传图片

export = {
  upload: async (req: Express.Request) =&gt; {
    await uploadFiles(req)                         // 同步执行工具函数
  }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>现在写好了<code>controller</code>逻辑，我们定义一个对应的接口路由；</p> <h3 id="定义接口路由"><a href="#定义接口路由" class="header-anchor">#</a> 定义接口路由</h3> <p>首先在<code>routes</code>路由文件夹中定义<code>api.ts</code>路由文件：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-----------routes / api.ts------------
var express = require('express')
var router = express.Router()

/* listing. */
router.post('/files_upload', async function(req, res, next) {        // 接口地址是/files_upload
  try {
    await api.upload(req)                 // 调用couroller中upload逻辑
    res.send('success~')                  // 成功就返回`success`
  } catch (error) {
    res.send('error! please reUpload!')
  }
})

module.exports = router
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>然后在根目录<code>app.ts</code>中注册接口路由：</p> <p>这里注册的就是一个根路由<code>api</code>，我们将刚才定义的路由接口文件，导入进来注册到<code>app</code>实例上；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>-----------app.ts------------
var apiRouter = require('./routes/api')             // 引入接口路由

app.use('/api', apiRouter)                       // 实例注册路由
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="完成接口"><a href="#完成接口" class="header-anchor">#</a> 完成接口</h3> <p>这样就定义好了一个接口路由，和对应的<code>controller</code>中处理逻辑代码；</p> <p>最终的接口地址为<code>http://localhost:3000/api/files_upload</code></p> <h3 id="测试接口"><a href="#测试接口" class="header-anchor">#</a> 测试接口</h3> <p>在<code>views</code>页面中，增加上传标签<code>input</code>；</p> <p>下面示例用<code>jade</code>，增加页面上传事件，即可发送请求将上传文件保存至指定位置；</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>extends layout

block content
  input(type=&quot;file&quot;, id=&quot;files&quot;)

  script.
    function uploadFiles() {
      const input = document.getElementById('files')
      const filesList = input.files[0];
      const form = new FormData()
      form.append('file', filesList)

      //- AJAX
      const url = 'http://localhost:3000/api/files_upload'
      const xhr = new XMLHttpRequest()
      xhr.open('post', url)
      xhr.send(form)
      xhr.onload = event =&gt; {
        console.log(event.target.responseText)
      }
    }
    document.getElementById('files').addEventListener('change', uploadFiles)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vbook/back-end/node/服务端鉴权.html" class="prev">
        服务端鉴权
      </a></span> <span class="next"><a href="/vbook/back-end/node/node后台-工具相关.html">
        node后台搭建-工具环境篇
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vbook/assets/js/app.64803a45.js" defer></script><script src="/vbook/assets/js/2.dceffa7a.js" defer></script><script src="/vbook/assets/js/25.ee58070b.js" defer></script>
  </body>
</html>
